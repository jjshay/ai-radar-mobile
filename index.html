<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>AI Radar Mobile</title>
  <style>
    /* CSS Variables - Dark theme with gold accents */
    :root {
      --bg-primary: #0a1628;
      --bg-secondary: #111d32;
      --bg-card: #1a2a44;
      --gold: #D4AF37;
      --gold-light: #f4d785;
      --gold-dark: #a08520;
      --text: #ffffff;
      --text-muted: #8a9bb3;
      --green: #4ade80;
      --red: #ef4444;
      --blue: #3b82f6;
      --purple: #a855f7;

      /* AI Model Colors */
      --ai-gpt: #10a37f;
      --ai-claude: #d97706;
      --ai-gemini: #4285f4;
      --ai-grok: #ffffff;
      --ai-pplx: #8b5cf6;

      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text);
    }

    /* Screen Container */
    .app {
      height: 100%;
      width: 100%;
      position: relative;
      overflow: hidden;
    }

    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }

    .screen.active {
      display: flex;
    }

    /* ============================================
       SCREEN 1: HOME
       ============================================ */
    #screen-home {
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 50px;
    }

    .logo-icon {
      width: 90px;
      height: 90px;
      flex-shrink: 0;
    }

    .logo-icon svg {
      width: 100%;
      height: 100%;
    }

    .logo-text-group {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .logo-text {
      font-size: 36px;
      font-weight: 700;
      color: white;
      letter-spacing: 2px;
      line-height: 1;
    }

    .logo-tagline {
      font-size: 16px;
      color: white;
      margin-top: 8px;
      letter-spacing: 1px;
    }

    /* Source Buttons Grid */
    .sources-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      width: 100%;
      max-width: 320px;
      margin-bottom: 20px;
    }

    .source-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 16px;
      padding: 20px 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .source-btn .name,
    .source-btn .count {
      color: #1e3a5f;
    }

    .source-btn:active {
      transform: scale(0.95);
    }

    .source-btn:hover {
      border-color: var(--gold);
      box-shadow: 0 0 25px rgba(212, 175, 55, 0.5);
    }

    .source-btn.selected {
      background: var(--gold);
      border-color: var(--gold);
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
    }

    .source-btn.selected .name,
    .source-btn.selected .count {
      color: #1a1a1a;
    }

    .source-btn.fetching {
      border-color: var(--gold);
      animation: pulse-border 1.5s infinite;
    }

    .source-btn.done {
      border-color: var(--green);
    }

    .source-btn .checkmark {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 22px;
      height: 22px;
      background: var(--gold);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--bg-primary);
    }

    .source-btn.selected .checkmark {
      display: flex;
    }

    .source-btn {
      position: relative;
    }

    @keyframes pulse-border {
      0%, 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
    }

    .source-btn .icon {
      width: 40px;
      height: 40px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .source-btn .icon img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .source-btn .name {
      font-size: 13px;
      font-weight: 600;
      color: #1e3a5f;
    }

    .source-btn .count {
      font-size: 11px;
      color: #1e3a5f;
      margin-top: 4px;
    }

    /* Topic Selector */
    .topic-selector {
      width: 100%;
      max-width: 320px;
      margin-bottom: 20px;
    }

    .topic-selector label {
      display: block;
      font-size: 12px;
      color: white;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .topic-selector select {
      width: 100%;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 16px;
      color: #1e3a5f;
      font-size: 16px;
      font-family: inherit;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%231e3a5f' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      cursor: pointer;
    }

    .topic-selector select:focus {
      outline: none;
      border-color: var(--gold);
    }

    .topic-selector select option {
      background: white;
      color: #1a1a1a;
      padding: 10px;
    }

    .topic-selector select optgroup {
      color: var(--gold);
      font-weight: 600;
    }

    /* Fetch All Button */
    .fetch-all-btn {
      width: 100%;
      max-width: 320px;
      padding: 18px;
      background: var(--gold);
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      color: #1a1a1a;
      cursor: pointer;
      margin-bottom: 15px;
      transition: all 0.2s;
    }

    .fetch-all-btn:hover {
      background: var(--gold-light);
    }

    .fetch-all-btn:active,
    .fetch-all-btn.clicked {
      background: #ffeb3b;
      transform: scale(0.97);
    }

    .fetch-all-btn:disabled {
      opacity: 0.5;
    }

    /* Favorites Button */
    .favorites-btn {
      width: 100%;
      max-width: 320px;
      padding: 16px;
      background: var(--bg-secondary);
      border: 2px solid var(--bg-card);
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .favorites-btn .badge {
      background: var(--red);
      color: white;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* ============================================
       SCREEN 2: SWIPE CARDS
       ============================================ */
    #screen-swipe {
      background: var(--bg-primary);
    }

    .swipe-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.1);
    }

    .swipe-card-counter {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .swipe-card-counter span {
      color: var(--gold);
    }

    .back-btn {
      background: none;
      border: none;
      color: #1e3a5f;
      font-size: 18px;
      cursor: pointer;
      padding: 10px;
      margin: -10px;
    }

    .article-count {
      font-size: 14px;
      color: #1e3a5f;
    }

    /* Card Stack */
    .card-stack {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    .swipe-card {
      position: absolute;
      width: calc(100% - 40px);
      max-width: 340px;
      height: auto;
      max-height: 420px;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      touch-action: none;
      user-select: none;
      transition: box-shadow 0.2s, transform 0.3s ease;
    }

    .swipe-card:hover {
      box-shadow: 0 8px 30px rgba(0,0,0,0.25), 0 0 20px rgba(212, 175, 55, 0.4);
    }

    .swipe-card.dragging {
      transition: none;
    }

    .swipe-card .card-image {
      width: 100%;
      height: 100px;
      background: var(--bg-secondary);
      background-size: cover;
      background-position: center;
      position: relative;
      flex-shrink: 0;
    }

    .swipe-card .card-image::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(transparent, white);
    }

    .swipe-card .card-body {
      padding: 12px 14px;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .swipe-card .card-source {
      display: inline-block;
      background: #f0f0f0;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 10px;
      color: #666;
      margin-bottom: 6px;
      align-self: flex-start;
    }

    .swipe-card .card-title {
      font-size: 14px;
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 6px;
      color: #1a1a1a;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .swipe-card .card-topics {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }

    .swipe-card .card-topic {
      background: linear-gradient(135deg, var(--gold-light), var(--gold));
      color: #1a1a1a;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 600;
    }

    .swipe-card .card-meta {
      display: flex;
      gap: 12px;
      font-size: 11px;
      color: #666;
      margin-bottom: 10px;
    }

    .swipe-card .card-meta span {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .swipe-card .card-score {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .swipe-card .score-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold);
    }

    .swipe-card .score-label {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* AI Scores Section */
    .ai-scores-section {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 8px;
      margin-top: auto;
    }

    .ai-score-item:active {
      transform: scale(0.95);
    }

    /* AI Detail Popup */
    .ai-detail-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .ai-detail-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      max-width: 320px;
      width: 100%;
    }

    .ai-detail-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .ai-detail-rationale {
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .ai-detail-close {
      width: 100%;
      padding: 12px;
      background: var(--gold);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--bg-primary);
      cursor: pointer;
    }

    .ai-scores-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .ai-scores-header .avg-score {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
    }

    .ai-scores-header .avg-label {
      font-size: 10px;
      color: var(--text-muted);
    }

    .ai-rationales {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 120px;
      overflow-y: auto;
    }

    .ai-rationale {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .ai-rationale .ai-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .ai-rationale .ai-icon.gpt { background: var(--ai-gpt); color: white; }
    .ai-rationale .ai-icon.claude { background: var(--ai-claude); color: white; }
    .ai-rationale .ai-icon.gemini { background: var(--ai-gemini); color: white; }
    .ai-rationale .ai-icon.grok { background: var(--ai-grok); color: var(--bg-primary); }
    .ai-rationale .ai-icon.pplx { background: var(--ai-pplx); color: white; }

    .ai-rationale .rationale-text {
      font-size: 10px;
      color: #666;
      line-height: 1.3;
    }

    .ai-rationale .rationale-score {
      font-weight: 600;
      color: #333;
    }

    /* Legacy badge styles for other screens */
    .ai-scores-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .ai-badge {
      display: flex;
      align-items: center;
      gap: 2px;
      background: var(--bg-secondary);
      padding: 4px 6px;
      border-radius: 12px;
      font-size: 10px;
    }

    .ai-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .ai-badge.gpt .dot { background: var(--ai-gpt); }
    .ai-badge.claude .dot { background: var(--ai-claude); }
    .ai-badge.gemini .dot { background: var(--ai-gemini); }
    .ai-badge.grok .dot { background: var(--ai-grok); }
    .ai-badge.pplx .dot { background: var(--ai-pplx); }

    /* Swipe Indicators */
    .swipe-indicator {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 48px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .swipe-indicator.left { left: 30px; }
    .swipe-indicator.right { right: 30px; }
    .swipe-indicator.up { top: 30px; left: 50%; transform: translateX(-50%); }
    .swipe-indicator.down { bottom: 30px; top: auto; left: 50%; transform: translateX(-50%); }

    /* Swipe Hints */
    .swipe-hints {
      padding: 20px;
      display: flex;
      justify-content: space-around;
      background: var(--bg-secondary);
    }

    .hint {
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
    }

    .hint .arrow {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .hint.hot .arrow { color: var(--green); }
    .hint.not .arrow { color: var(--red); }
    .hint.delete .arrow { color: var(--text-muted); }
    .hint.post .arrow { color: var(--gold); }

    /* ============================================
       SCREEN 3: ARTICLE DETAIL
       ============================================ */
    #screen-detail {
      background: var(--bg-primary);
    }

    .detail-header {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      background: var(--bg-secondary);
    }

    .detail-content {
      flex: 1;
      overflow-y: auto;
    }

    .detail-image {
      width: 100%;
      height: 200px;
      background: var(--bg-secondary);
      background-size: cover;
      background-position: center;
    }

    .detail-body {
      padding: 20px;
    }

    .detail-source {
      display: inline-block;
      background: var(--bg-card);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    .detail-title {
      font-size: 26px;
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 20px;
    }

    .detail-summary {
      font-size: 16px;
      color: var(--text-muted);
      line-height: 1.7;
      margin-bottom: 30px;
    }

    .detail-scores {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
    }

    .detail-scores h3 {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 15px;
    }

    .detail-scores .score-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }

    .detail-scores .score-item {
      text-align: center;
    }

    .detail-scores .score-item .value {
      font-size: 24px;
      font-weight: 700;
    }

    .detail-scores .score-item .label {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .detail-scores .score-item.gpt .value { color: var(--ai-gpt); }
    .detail-scores .score-item.claude .value { color: var(--ai-claude); }
    .detail-scores .score-item.gemini .value { color: var(--ai-gemini); }
    .detail-scores .score-item.grok .value { color: var(--ai-grok); }
    .detail-scores .score-item.pplx .value { color: var(--ai-pplx); }

    /* Length Selector (Bottom 20%) */
    .length-selector {
      background: var(--bg-secondary);
      padding: 20px;
      border-top: 1px solid var(--bg-card);
    }

    .length-selector h3 {
      font-size: 14px;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 15px;
    }

    .length-options {
      display: flex;
      gap: 10px;
    }

    .length-btn {
      flex: 1;
      padding: 18px 15px;
      background: var(--bg-card);
      border: 2px solid transparent;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .length-btn:active {
      transform: scale(0.95);
    }

    .length-btn.selected {
      border-color: var(--gold);
      background: rgba(212, 175, 55, 0.1);
    }

    .length-btn .slides {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold);
    }

    .length-btn .label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 5px;
    }

    .generate-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      color: var(--bg-primary);
      cursor: pointer;
      margin-top: 15px;
    }

    .generate-btn:active {
      transform: scale(0.97);
    }

    /* ============================================
       SCREEN 4: PIPELINE
       ============================================ */
    #screen-pipeline {
      background: var(--bg-primary);
      justify-content: center;
      align-items: center;
      padding: 30px;
    }

    .pipeline-title {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 10px;
      color: #1e3a5f;
    }

    .pipeline-subtitle {
      font-size: 14px;
      color: #1e3a5f;
      text-align: center;
      margin-bottom: 40px;
    }

    /* Progress Ring */
    .progress-container {
      width: 200px;
      height: 200px;
      position: relative;
      margin-bottom: 40px;
    }

    .progress-ring {
      transform: rotate(-90deg);
    }

    .progress-ring-bg {
      fill: none;
      stroke: var(--bg-card);
      stroke-width: 12;
    }

    .progress-ring-fill {
      fill: none;
      stroke: var(--gold);
      stroke-width: 12;
      stroke-linecap: round;
      stroke-dasharray: 565;
      stroke-dashoffset: 565;
      transition: stroke-dashoffset 0.5s ease;
    }

    .progress-percent {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      font-weight: 700;
      color: var(--gold);
    }

    .progress-message {
      font-size: 16px;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 30px;
      min-height: 24px;
    }

    /* Pipeline Steps */
    .pipeline-steps {
      width: 100%;
      max-width: 300px;
    }

    .pipeline-step {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid var(--bg-card);
    }

    .pipeline-step:last-child {
      border-bottom: none;
    }

    .pipeline-step .step-icon {
      width: 40px;
      height: 40px;
      background: var(--bg-card);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .pipeline-step.active .step-icon {
      background: var(--gold);
      animation: pulse 1s infinite;
    }

    .pipeline-step.done .step-icon {
      background: var(--green);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .pipeline-step .step-label {
      font-size: 14px;
      color: var(--text-muted);
    }

    .pipeline-step.active .step-label,
    .pipeline-step.done .step-label {
      color: var(--text);
    }

    /* Success State */
    .pipeline-success {
      text-align: center;
      display: none;
    }

    .pipeline-success.show {
      display: block;
    }

    .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .success-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .success-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 30px;
    }

    .view-post-btn {
      display: inline-block;
      padding: 16px 40px;
      background: var(--blue);
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      text-decoration: none;
      margin-bottom: 15px;
    }

    .new-post-btn {
      display: block;
      padding: 16px;
      background: var(--bg-card);
      border: none;
      border-radius: 16px;
      font-size: 16px;
      color: var(--text);
      cursor: pointer;
      width: 100%;
      max-width: 250px;
      margin: 0 auto;
    }

    /* ============================================
       SCREEN 5: FAVORITES
       ============================================ */
    #screen-favorites {
      background: var(--bg-primary);
    }

    .favorites-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-secondary);
      gap: 10px;
    }

    .favorites-header h1 {
      flex: 1;
      font-size: 16px;
      margin: 0;
    }

    .favorites-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .favorites-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .favorites-empty .icon {
      font-size: 40px;
      margin-bottom: 10px;
      opacity: 0.3;
    }

    .favorite-item {
      background: white;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 8px;
      position: relative;
    }

    .favorite-item .delete-x {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .favorite-item .fav-source {
      display: inline-block;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 9px;
      color: #666;
      margin-bottom: 4px;
    }

    .favorite-item .fav-title {
      font-size: 12px;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 4px;
      color: #1a1a1a;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .favorite-item .fav-topics {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      margin-bottom: 6px;
    }

    .favorite-item .fav-topic {
      background: linear-gradient(135deg, var(--gold-light), var(--gold));
      color: #1a1a1a;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 8px;
      font-weight: 600;
    }

    .favorite-item .fav-meta {
      display: flex;
      gap: 10px;
      font-size: 10px;
      color: #666;
      margin-bottom: 6px;
    }

    .favorite-item .fav-scores {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .favorite-item .fav-avg {
      font-size: 14px;
      font-weight: 700;
      color: var(--gold);
    }

    .favorite-item .fav-logos {
      display: flex;
      gap: 4px;
    }

    .favorite-item .fav-logos img {
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }

    .favorite-item .fav-expanded {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e0e0e0;
    }

    .favorite-item .fav-description {
      font-size: 11px;
      color: #555;
      line-height: 1.4;
      margin-bottom: 10px;
    }

    .favorite-item .fav-create-btn {
      width: 100%;
      padding: 10px;
      background: var(--gold);
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: var(--bg-primary);
      cursor: pointer;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 22, 40, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .loading-overlay.show {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--bg-card);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      padding: 15px 25px;
      border-radius: 30px;
      font-size: 14px;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 200;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* ============================================
       SCREEN 5: RESULTS
       ============================================ */
    #screen-results {
      background: var(--bg-primary);
      padding: 30px 20px;
    }

    .results-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .results-header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      color: white;
    }

    .results-subtitle {
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Source Info Bar */
    .results-source-info {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 12px 15px;
      margin-bottom: 20px;
    }

    .results-source-info .source-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: contain;
      background: white;
      padding: 4px;
    }

    .results-source-info .source-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .results-source-info .source-name {
      font-size: 12px;
      color: var(--gold);
      font-weight: 600;
      text-transform: uppercase;
    }

    .results-source-info .article-title-mini {
      font-size: 14px;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .results-preview {
      margin-bottom: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Gamma Embed - Mobile First */
    #gamma-embed-container {
      width: 100%;
      aspect-ratio: 9/16;
      max-height: 65vh;
      min-height: 300px;
      border-radius: 12px;
      overflow: hidden;
      background: #1a1a2e;
      position: relative;
      margin: 0 auto;
    }

    #gamma-embed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Flipbook Carousel */
    .flipbook-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .flipbook {
      flex: 1;
      position: relative;
      background: var(--bg-card);
      border-radius: 20px;
      overflow: hidden;
      min-height: 280px;
    }

    .flip-slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.4s ease;
      padding: 25px;
    }

    .flip-slide.active {
      opacity: 1;
      transform: translateX(0);
    }

    .flip-slide.prev {
      opacity: 0;
      transform: translateX(-100%);
    }

    .slide-content {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .slide-number {
      width: 40px;
      height: 40px;
      background: var(--gold);
      color: var(--bg-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .slide-title {
      font-size: 20px;
      font-weight: 700;
      line-height: 1.3;
      color: var(--gold);
    }

    .slide-body {
      font-size: 16px;
      line-height: 1.6;
      color: var(--text-muted);
    }

    .flipbook-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 15px;
    }

    .flip-prev, .flip-next {
      width: 44px;
      height: 44px;
      background: var(--bg-card);
      border: none;
      border-radius: 50%;
      font-size: 24px;
      color: var(--text);
      cursor: pointer;
    }

    .flip-prev:active, .flip-next:active {
      transform: scale(0.9);
    }

    .flip-dots {
      display: flex;
      gap: 8px;
    }

    .flip-dot {
      width: 8px;
      height: 8px;
      background: var(--bg-card);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }

    .flip-dot.active {
      background: var(--gold);
      width: 24px;
      border-radius: 4px;
    }

    .flipbook-hint {
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 15px;
    }

    .results-actions {
      margin-bottom: 30px;
    }

    .results-actions h3 {
      font-size: 14px;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 15px;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
    }

    .action-btn {
      flex: 1;
      padding: 20px 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      text-align: center;
      text-decoration: none;
      color: var(--text);
      transition: all 0.2s;
      border: 2px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .action-btn:active {
      transform: scale(0.95);
    }

    .action-btn .btn-icon {
      font-size: 28px;
      display: block;
      margin-bottom: 8px;
    }

    .action-btn .btn-label {
      font-size: 13px;
      font-weight: 600;
    }

    .action-btn.gamma:hover,
    .action-btn.gamma:active {
      border-color: var(--purple);
      background: rgba(168, 85, 247, 0.15);
    }

    .action-btn.download:hover,
    .action-btn.download:active {
      border-color: var(--green);
      background: rgba(74, 222, 128, 0.15);
    }

    .action-btn.linkedin:hover,
    .action-btn.linkedin:active {
      border-color: var(--blue);
      background: rgba(59, 130, 246, 0.15);
    }

    .results-post {
      margin-top: auto;
    }

    .post-final-btn {
      width: 100%;
      padding: 20px;
      background: linear-gradient(135deg, var(--blue), #1d4ed8);
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      color: white;
      cursor: pointer;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .post-final-btn:active {
      transform: scale(0.97);
    }

    .skip-btn {
      width: 100%;
      padding: 16px;
      background: transparent;
      border: 2px solid var(--bg-card);
      border-radius: 16px;
      font-size: 16px;
      color: var(--text-muted);
      cursor: pointer;
    }

    /* Article Detail Modal */
    .article-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 22, 40, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 240;
      padding: 20px;
      overflow-y: auto;
    }

    .article-modal.show {
      display: flex;
    }

    .article-modal-content {
      width: 100%;
      max-width: 400px;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      max-height: 90vh;
      overflow-y: auto;
    }

    .article-modal-image {
      width: 100%;
      height: 180px;
      background-size: cover;
      background-position: center;
    }

    .article-modal-body {
      padding: 20px;
    }

    .article-modal-source {
      display: inline-block;
      background: #f0f0f0;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #666;
      margin-bottom: 12px;
    }

    .article-modal-title {
      font-size: 22px;
      font-weight: 700;
      color: #1a1a1a;
      line-height: 1.3;
      margin-bottom: 15px;
    }

    .article-modal-meta {
      display: flex;
      gap: 15px;
      font-size: 12px;
      color: #888;
      margin-bottom: 15px;
    }

    .article-modal-description {
      font-size: 14px;
      color: #444;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .ai-consensus {
      background: #f8f8f8;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .ai-consensus-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .ai-consensus-header .score {
      font-size: 28px;
      font-weight: 700;
      color: var(--gold);
    }

    .ai-consensus-header .label {
      font-size: 12px;
      color: #666;
    }

    .ai-consensus-text {
      font-size: 13px;
      color: #555;
      line-height: 1.5;
    }

    .article-modal-close {
      width: 100%;
      padding: 16px;
      background: #1a1a1a;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
    }

    /* Length Selection Modal */
    .length-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 22, 40, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 250;
      padding: 30px;
    }

    .length-modal.show {
      display: flex;
    }

    .length-modal-content {
      width: 100%;
      max-width: 340px;
    }

    .length-modal h2 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 10px;
      color: white;
    }

    .length-modal .subtitle {
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 30px;
    }

    .length-modal .length-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .length-modal .length-option {
      background: white;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 20px;
      transition: all 0.2s;
    }

    .length-modal .length-option:active {
      transform: scale(0.98);
    }

    .length-modal .length-option:hover {
      border-color: var(--gold);
      background: rgba(212, 175, 55, 0.1);
    }

    .length-modal .length-option .slides-count {
      width: 60px;
      height: 60px;
      background: #f5f5f5;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--gold);
      font-weight: 700;
      color: var(--gold);
    }

    .length-modal .length-option .length-info h3 {
      font-size: 18px;
      margin-bottom: 4px;
      color: #1a1a1a;
    }

    .length-modal .length-option .length-info p {
      font-size: 13px;
      color: #666;
    }

    .length-modal .cancel-btn {
      width: 100%;
      padding: 16px;
      background: transparent;
      border: 2px solid var(--bg-card);
      border-radius: 16px;
      font-size: 16px;
      color: var(--text-muted);
      cursor: pointer;
      margin-top: 20px;
    }

    /* ============================================
       CARD GENERATION SCREEN
       ============================================ */
    #screen-generating {
      background: var(--bg-primary);
      justify-content: flex-start;
      padding: 15px 20px;
      overflow-y: auto;
    }

    .generating-header {
      text-align: center;
      margin-bottom: 12px;
    }

    .generating-header h1 {
      font-size: 18px;
      margin-bottom: 4px;
      color: var(--gold);
    }

    .generating-status {
      color: var(--text-muted);
      font-size: 12px;
    }

    /* Gamma Logo Highlight */
    .gamma-highlight {
      display: flex;
      justify-content: center;
      margin-bottom: 12px;
    }

    .gamma-logo-box {
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
      padding: 8px 16px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
      animation: gamma-glow 2s ease-in-out infinite;
    }

    @keyframes gamma-glow {
      0%, 100% { box-shadow: 0 0 30px rgba(168, 85, 247, 0.4); }
      50% { box-shadow: 0 0 50px rgba(168, 85, 247, 0.7); }
    }

    .gamma-logo-box svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    .gamma-logo-box span {
      font-size: 14px;
      font-weight: 700;
      color: white;
    }

    /* Card Counter */
    .card-counter {
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: white;
      margin-bottom: 10px;
    }

    .card-counter span {
      color: var(--gold);
    }

    /* Single Progress Card */
    .generation-cards {
      display: flex;
      justify-content: center;
      margin-bottom: 12px;
    }

    .gen-card-single {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
    }

    .gen-card-single .step-num {
      font-size: 36px;
      font-weight: 700;
      color: var(--bg-primary);
      line-height: 1;
      transition: transform 0.15s ease;
    }

    .gen-card-single .step-total {
      font-size: 12px;
      color: var(--bg-primary);
      opacity: 0.7;
    }

    .gen-step-description {
      text-align: center;
      font-size: 13px;
      color: var(--text);
      margin-bottom: 15px;
      min-height: 20px;
      transition: opacity 0.2s ease;
    }

    .gen-card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s ease;
    }

    .gen-card.flipped .gen-card-inner {
      transform: rotateY(180deg);
    }

    .gen-card-front, .gen-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    .gen-card-front {
      background: var(--bg-card);
      border: 2px solid rgba(255,255,255,0.1);
    }

    .gen-card-front .card-num {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255,255,255,0.3);
    }

    .gen-card-back {
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      transform: rotateY(180deg);
    }

    .gen-card-back .card-icon {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .gen-card-back .card-step {
      font-size: 6px;
      font-weight: 600;
      color: var(--bg-primary);
      text-align: center;
      line-height: 1;
      padding: 0 2px;
      display: none;
    }

    .gen-card.flipping .gen-card-inner {
      animation: card-flip-bounce 0.6s ease;
    }

    @keyframes card-flip-bounce {
      0% { transform: rotateY(0deg) scale(1); }
      50% { transform: rotateY(90deg) scale(1.1); }
      100% { transform: rotateY(180deg) scale(1); }
    }

    /* AI Commentary Box */
    .ai-commentary {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 12px;
    }

    .ai-commentary-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .ai-commentary-header .ai-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
    }

    .ai-commentary-header .ai-name {
      font-weight: 600;
      font-size: 12px;
    }

    .ai-commentary-header .typing-dots {
      display: none;
      gap: 3px;
    }

    .ai-commentary-header .typing-dots.active {
      display: flex;
    }

    .ai-commentary-header .typing-dots span {
      width: 4px;
      height: 4px;
      background: var(--gold);
      border-radius: 50%;
      animation: typing-bounce 1.4s infinite both;
    }

    .ai-commentary-header .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .ai-commentary-header .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing-bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    .ai-commentary-text {
      font-size: 11px;
      line-height: 1.4;
      color: var(--text-muted);
      min-height: 28px;
    }

    /* Progress Bar */
    .generation-progress {
      background: var(--bg-card);
      border-radius: 6px;
      height: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .generation-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold) 0%, var(--gold-light) 100%);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 10px;
    }

    .generation-percent {
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      margin: 0;
    }

    /* Posted Success Modal */
    .success-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 22, 40, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
      padding: 30px;
    }

    .success-modal.show {
      display: flex;
    }

    .success-modal-content {
      text-align: center;
    }

    .success-modal .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .success-modal .success-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--green);
    }

    .success-modal .success-subtitle {
      font-size: 16px;
      color: var(--text-muted);
      margin-bottom: 30px;
    }

    .success-modal .view-post-btn {
      display: inline-block;
      padding: 16px 40px;
      background: var(--blue);
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      text-decoration: none;
      margin-bottom: 15px;
    }

    .success-modal .new-post-btn {
      display: block;
      padding: 16px 30px;
      background: var(--bg-card);
      border: none;
      border-radius: 16px;
      font-size: 16px;
      color: var(--text);
      cursor: pointer;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- SCREEN 1: HOME -->
    <div id="screen-home" class="screen active">
      <div class="logo-container">
        <div class="logo-icon">
          <svg viewBox="0 0 100 100" fill="none" stroke="white" stroke-width="2">
            <circle cx="50" cy="50" r="47"/>
            <circle cx="50" cy="50" r="41"/>
            <circle cx="50" cy="50" r="35"/>
            <circle cx="50" cy="50" r="26"/>
            <path d="M32 68 L50 28 L68 68" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M38 58 L62 58" stroke-width="4" stroke-linecap="round"/>
            <path d="M72 32 L72 68" stroke-width="4" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="logo-text-group">
          <div class="logo-text">AI RADAR</div>
          <div class="logo-tagline">Intelligence Engine</div>
        </div>
      </div>

      <!-- Topic Dropdown - At Top -->
      <div class="topic-selector">
        <label>Search Topic</label>
        <select id="topic-dropdown" onchange="setTopicAndFetchCounts(this.value)">
          <optgroup label="AI & Technology">
            <option value="artificial intelligence" selected>Artificial Intelligence</option>
            <option value="machine learning">Machine Learning</option>
            <option value="large language models">Large Language Models</option>
            <option value="robotics">Robotics</option>
            <option value="autonomous vehicles">Autonomous Vehicles</option>
          </optgroup>
          <optgroup label="Business & Finance">
            <option value="startups">Startups & VC</option>
            <option value="fintech">Fintech</option>
            <option value="cryptocurrency">Cryptocurrency</option>
            <option value="stock market">Stock Market</option>
          </optgroup>
          <optgroup label="Industry">
            <option value="healthcare ai">Healthcare AI</option>
            <option value="climate tech">Climate Tech</option>
            <option value="cybersecurity">Cybersecurity</option>
            <option value="space technology">Space Technology</option>
          </optgroup>
        </select>
      </div>

      <div class="sources-grid">
        <div class="source-btn" data-source="newsapi" onclick="toggleSource('newsapi')">
          <div class="checkmark">✓</div>
          <div class="icon"><img src="assets/newsapi.png" alt="NewsAPI"></div>
          <div class="name">NewsAPI</div>
          <div class="count">-</div>
        </div>
        <div class="source-btn" data-source="newsdata" onclick="toggleSource('newsdata')">
          <div class="checkmark">✓</div>
          <div class="icon"><img src="assets/newsdata.png" alt="NewsData"></div>
          <div class="name">NewsData</div>
          <div class="count">-</div>
        </div>
        <div class="source-btn" data-source="perplexity" onclick="toggleSource('perplexity')">
          <div class="checkmark">✓</div>
          <div class="icon"><img src="assets/perplexity.png" alt="Perplexity"></div>
          <div class="name">Perplexity</div>
          <div class="count">-</div>
        </div>
        <div class="source-btn" data-source="grok" onclick="toggleSource('grok')">
          <div class="checkmark">✓</div>
          <div class="icon"><img src="logos/grok.png" alt="Grok"></div>
          <div class="name">Grok</div>
          <div class="count">-</div>
        </div>
      </div>

      <button class="fetch-all-btn" onclick="fetchAllSources()">
        FETCH ALL SOURCES
      </button>

    </div>

    <!-- SCREEN 2: AI SCORING ANIMATION -->
    <div id="screen-scoring" class="screen" style="justify-content: center; align-items: center; padding: 40px 20px;">
      <div style="text-align: center; margin-bottom: 40px;">
        <h2 style="font-size: 24px; margin-bottom: 10px; color: var(--gold);">Analyzing Articles</h2>
        <p style="color: var(--text-muted); font-size: 14px;">5 AI models scoring your articles...</p>
      </div>

      <!-- AI Logos with animated dots -->
      <div id="ai-scoring-dots" style="display: flex; gap: 20px; margin-bottom: 40px;">
        <div class="ai-score-logo" id="score-gpt" style="display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.5s;">
          <img src="logos/chatgpt.png" alt="ChatGPT" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
          <span style="font-size: 10px; margin-top: 5px; color: var(--text-muted);">GPT</span>
        </div>
        <div class="ai-score-logo" id="score-claude" style="display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.5s;">
          <img src="logos/claude.png" alt="Claude" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
          <span style="font-size: 10px; margin-top: 5px; color: var(--text-muted);">Claude</span>
        </div>
        <div class="ai-score-logo" id="score-gemini" style="display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.5s;">
          <img src="logos/gemini.png" alt="Gemini" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
          <span style="font-size: 10px; margin-top: 5px; color: var(--text-muted);">Gemini</span>
        </div>
        <div class="ai-score-logo" id="score-grok" style="display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.5s;">
          <img src="logos/grok.png" alt="Grok" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #333;">
          <span style="font-size: 10px; margin-top: 5px; color: var(--text-muted);">Grok</span>
        </div>
        <div class="ai-score-logo" id="score-pplx" style="display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.5s;">
          <img src="logos/perplexity.png" alt="Perplexity" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #fff;">
          <span style="font-size: 10px; margin-top: 5px; color: var(--text-muted);">Pplx</span>
        </div>
      </div>

      <div id="scoring-status" style="color: var(--text-muted); font-size: 14px;">Initializing...</div>
      <div id="scoring-count" style="color: var(--gold); font-size: 18px; margin-top: 10px; font-weight: bold;">0 articles scored</div>
    </div>

    <!-- SCREEN 3: SWIPE CARDS -->
    <div id="screen-swipe" class="screen">
      <div class="swipe-header">
        <button class="back-btn" onclick="showScreen('home')">← Back</button>
        <div class="swipe-card-counter" id="swipe-card-counter">Card <span>1</span> of <span>0</span></div>
        <button class="saved-btn" onclick="showScreen('favorites')" style="background: var(--gold); color: var(--bg-primary); border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
          Saved <span id="fav-count" style="background: var(--bg-primary); color: var(--gold); padding: 2px 6px; border-radius: 10px; margin-left: 4px;">0</span>
        </button>
      </div>

      <div class="card-stack" id="card-stack">
        <!-- Cards inserted dynamically -->
        <div class="swipe-indicator left">⏭️</div>
        <div class="swipe-indicator right">🎨</div>
        <div class="swipe-indicator up">🚫</div>
        <div class="swipe-indicator down">📌</div>
      </div>

      <div class="swipe-hints">
        <div class="hint not">
          <div class="arrow">← SKIP</div>
        </div>
        <div class="hint save">
          <div class="arrow">↑ NOT INTERESTED</div>
        </div>
        <div class="hint delete">
          <div class="arrow">↓ SAVE</div>
        </div>
        <div class="hint create">
          <div class="arrow">CREATE →</div>
        </div>
      </div>
    </div>

    <!-- SCREEN 3: ARTICLE DETAIL -->
    <div id="screen-detail" class="screen">
      <div class="detail-header">
        <button class="back-btn" onclick="showScreen('swipe')">← Back</button>
      </div>

      <div class="detail-content">
        <div class="detail-image" id="detail-image"></div>
        <div class="detail-body">
          <div class="detail-source" id="detail-source">TechCrunch</div>
          <h1 class="detail-title" id="detail-title">Article Title</h1>
          <p class="detail-summary" id="detail-summary">Article summary goes here...</p>

          <div class="detail-scores">
          <h3>AI Consensus Scores</h3>
          <div class="score-grid">
            <div class="score-item gpt">
              <div class="value" id="score-gpt">-</div>
              <div class="label">GPT</div>
            </div>
            <div class="score-item claude">
              <div class="value" id="score-claude">-</div>
              <div class="label">Claude</div>
            </div>
            <div class="score-item gemini">
              <div class="value" id="score-gemini">-</div>
              <div class="label">Gemini</div>
            </div>
            <div class="score-item grok">
              <div class="value" id="score-grok">-</div>
              <div class="label">Grok</div>
            </div>
            <div class="score-item pplx">
              <div class="value" id="score-pplx">-</div>
              <div class="label">Perplexity</div>
            </div>
          </div>
        </div>
        </div>
      </div>

      <div class="length-selector">
        <h3>Select Slide Length</h3>
        <div class="length-options">
          <div class="length-btn" data-length="short" onclick="selectLength('short')">
            <div class="slides">5</div>
            <div class="label">Short</div>
          </div>
          <div class="length-btn selected" data-length="medium" onclick="selectLength('medium')">
            <div class="slides">8</div>
            <div class="label">Medium</div>
          </div>
          <div class="length-btn" data-length="long" onclick="selectLength('long')">
            <div class="slides">12</div>
            <div class="label">Long</div>
          </div>
        </div>
        <button class="generate-btn" onclick="startPipeline()">
          GENERATE & POST
        </button>
      </div>
    </div>

    <!-- SCREEN 4: PIPELINE -->
    <div id="screen-pipeline" class="screen">
      <div class="pipeline-progress" id="pipeline-progress">
        <h1 class="pipeline-title">Generating...</h1>
        <p class="pipeline-subtitle">Creating your LinkedIn carousel</p>

        <div class="progress-container">
          <svg class="progress-ring" width="200" height="200">
            <circle class="progress-ring-bg" cx="100" cy="100" r="90"/>
            <circle class="progress-ring-fill" id="progress-fill" cx="100" cy="100" r="90"/>
          </svg>
          <div class="progress-percent" id="progress-percent">0%</div>
        </div>

        <p class="progress-message" id="progress-message">Initializing...</p>

        <div class="pipeline-steps">
          <div class="pipeline-step" id="step-analyze">
            <div class="step-icon">📝</div>
            <div class="step-label">Analyzing article</div>
          </div>
          <div class="pipeline-step" id="step-slides">
            <div class="step-icon">🎨</div>
            <div class="step-label">Creating slides</div>
          </div>
          <div class="pipeline-step" id="step-review">
            <div class="step-icon">🤖</div>
            <div class="step-label">AI review</div>
          </div>
          <div class="pipeline-step" id="step-post">
            <div class="step-icon">📤</div>
            <div class="step-label">Posting to LinkedIn</div>
          </div>
        </div>
      </div>

      <div class="pipeline-success" id="pipeline-success">
        <div class="success-icon">✓</div>
        <h2>Complete!</h2>
      </div>

    </div>

    <!-- SCREEN 5: RESULTS (Human in the Loop) -->
    <div id="screen-results" class="screen">
      <div class="results-header">
        <h1>Ready to Post</h1>
        <p class="results-subtitle">Review your content before posting</p>
      </div>

      <!-- Article Source Info -->
      <div class="results-source-info" id="results-source-info">
        <img src="" alt="" class="source-logo" id="results-source-logo">
        <div class="source-details">
          <span class="source-name" id="results-source-name">Source</span>
          <span class="article-title-mini" id="results-article-title">Article Title</span>
        </div>
      </div>

      <div class="results-preview">
        <!-- Gamma Embed (shows real slides - mobile optimized) -->
        <div id="gamma-embed-container" style="display: none;">
          <iframe id="gamma-embed" src="" allowfullscreen></iframe>
        </div>

        <!-- Fallback Flipbook (when no Gamma URL) -->
        <div class="flipbook-container" id="flipbook-container">
          <div class="flipbook" id="flipbook">
            <div class="flip-slide active" data-slide="1">
              <div class="slide-content">
                <div class="slide-number">1</div>
                <div class="slide-title" id="slide-title-1">Loading...</div>
              </div>
            </div>
            <div class="flip-slide" data-slide="2">
              <div class="slide-content">
                <div class="slide-number">2</div>
                <div class="slide-body">Key insights from the article...</div>
              </div>
            </div>
            <div class="flip-slide" data-slide="3">
              <div class="slide-content">
                <div class="slide-number">3</div>
                <div class="slide-body">Main points and analysis...</div>
              </div>
            </div>
            <div class="flip-slide" data-slide="4">
              <div class="slide-content">
                <div class="slide-number">4</div>
                <div class="slide-body">Industry implications...</div>
              </div>
            </div>
            <div class="flip-slide" data-slide="5">
              <div class="slide-content">
                <div class="slide-number">5</div>
                <div class="slide-body">Call to action & conclusion</div>
              </div>
            </div>
          </div>
          <div class="flipbook-nav">
            <button class="flip-prev" onclick="flipPrev()">‹</button>
            <div class="flip-dots" id="flip-dots">
              <span class="flip-dot active" data-index="0"></span>
              <span class="flip-dot" data-index="1"></span>
              <span class="flip-dot" data-index="2"></span>
              <span class="flip-dot" data-index="3"></span>
              <span class="flip-dot" data-index="4"></span>
            </div>
            <button class="flip-next" onclick="flipNext()">›</button>
          </div>
          <div class="flipbook-hint">Swipe to preview slides</div>
        </div>
      </div>

      <div class="results-actions">
        <h3>Open in:</h3>
        <div class="action-buttons">
          <a href="#" class="action-btn gamma" id="gamma-link" target="_blank">
            <span class="btn-icon">
              <svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
              </svg>
            </span>
            <span class="btn-label">Gamma</span>
          </a>
          <a href="#" class="action-btn download" id="download-link" target="_blank">
            <span class="btn-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
            </span>
            <span class="btn-label">Download</span>
          </a>
          <a href="#" class="action-btn linkedin" id="linkedin-link" target="_blank">
            <span class="btn-icon">
              <svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
              </svg>
            </span>
            <span class="btn-label">LinkedIn</span>
          </a>
        </div>
      </div>

      <div class="results-post">
        <button class="post-final-btn" onclick="finalPost()">
          POST TO LINKEDIN
        </button>
        <button class="skip-btn" onclick="skipAndNext()">
          Skip & Next Article
        </button>
      </div>
    </div>

    <!-- SCREEN 5: FAVORITES / SAVED -->
    <div id="screen-favorites" class="screen">
      <div class="favorites-header">
        <button class="back-btn" onclick="showScreen('swipe')">← Back</button>
        <h1>Saved Articles</h1>
        <button class="clear-all-btn" onclick="clearAllSaved()" style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 6px 12px; border-radius: 8px; font-size: 11px; cursor: pointer;">Clear All</button>
      </div>

      <div class="favorites-list" id="favorites-list">
        <div class="favorites-empty">
          <div class="icon">📌</div>
          <p>No saved articles yet.<br>Swipe down on articles to save them!</p>
        </div>
      </div>
    </div>

    <!-- Article Detail Modal -->
    <div class="article-modal" id="article-modal">
      <div class="article-modal-content">
        <div class="article-modal-image" id="modal-image"></div>
        <div class="article-modal-body">
          <div class="article-modal-source" id="modal-source">Source</div>
          <h2 class="article-modal-title" id="modal-title">Article Title</h2>
          <div class="article-modal-meta">
            <span id="modal-date">Today</span>
            <span id="modal-pages">3 pages</span>
          </div>
          <p class="article-modal-description" id="modal-description">
            Full article description goes here...
          </p>

          <div class="ai-consensus">
            <div class="ai-consensus-header">
              <span class="score" id="modal-score">8.5</span>
              <span class="label">AI Consensus Score</span>
            </div>
            <p class="ai-consensus-text" id="modal-consensus">
              All 5 AI models agree this article has high relevance and engagement potential.
              Strong news value with timely topic coverage and credible sourcing.
            </p>
          </div>

          <button class="article-modal-close" onclick="hideArticleModal()">Close</button>
        </div>
      </div>
    </div>

    <!-- Length Selection Modal -->
    <div class="length-modal" id="length-modal">
      <div class="length-modal-content">
        <h2>Select Length</h2>
        <p class="subtitle">How many slides do you want?</p>

        <div class="length-options">
          <div class="length-option" onclick="selectLengthAndGenerate('short')">
            <div class="slides-count">4-5</div>
            <div class="length-info">
              <h3>Short</h3>
              <p>Quick highlights, perfect for fast reads</p>
            </div>
          </div>

          <div class="length-option" onclick="selectLengthAndGenerate('medium')">
            <div class="slides-count">10-12</div>
            <div class="length-info">
              <h3>Medium</h3>
              <p>Balanced coverage with key insights</p>
            </div>
          </div>

          <div class="length-option" onclick="selectLengthAndGenerate('long')">
            <div class="slides-count">18-20</div>
            <div class="length-info">
              <h3>Long</h3>
              <p>Deep dive with full analysis</p>
            </div>
          </div>
        </div>

        <button class="cancel-btn" onclick="hideLengthModal()">Cancel</button>
      </div>
    </div>

    <!-- SCREEN: Card Generation -->
    <div id="screen-generating" class="screen" style="justify-content: center; align-items: center; padding: 20px;">
      <!-- Gamma Logo -->
      <div class="gamma-highlight">
        <div class="gamma-logo-box">
          <img src="logos/gamma.png" alt="Gamma" style="width: 24px; height: 24px; border-radius: 6px;">
          <span>Gamma</span>
        </div>
      </div>

      <!-- Status -->
      <p id="generating-status" style="color: var(--text-muted); font-size: 12px; margin: 10px 0;">Creating carousel...</p>

      <!-- Single Card with Step Number -->
      <div class="generation-cards">
        <div class="gen-card-single">
          <div class="step-num" id="step-num">1</div>
          <div class="step-total" id="step-total">of 8</div>
        </div>
      </div>

      <!-- Step Description -->
      <p class="gen-step-description" id="gen-step-description">Analyzing article content...</p>

      <!-- Audio Summary -->
      <div style="margin: 15px 0; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <button id="audio-btn" onclick="toggleAudioSummary()" style="background: var(--gold); border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; color: var(--bg-primary); cursor: pointer; display: flex; align-items: center; gap: 6px;">
          <span id="audio-icon">🎧</span> <span id="audio-text">Listen</span>
        </button>
        <button id="mic-btn" onclick="toggleVoiceChat()" style="display: none; background: var(--accent); border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; color: white; cursor: pointer; align-items: center; gap: 6px;">
          <span id="mic-icon">🎤</span> <span id="mic-text">Ask</span>
        </button>
        <span id="audio-status" style="font-size: 11px; color: var(--text-muted);"></span>
      </div>
      <audio id="summary-audio" style="display: none;"></audio>
      <audio id="voice-response-audio" style="display: none;"></audio>

      <!-- Progress -->
      <div style="width: 100%; max-width: 250px;">
        <div class="generation-progress">
          <div class="generation-progress-fill" id="gen-progress-fill"></div>
        </div>
        <p class="generation-percent" id="gen-percent">0%</p>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
      <div class="spinner"></div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="success-modal">
      <div class="success-modal-content">
        <div class="success-icon">✅</div>
        <h1 class="success-title">Posted!</h1>
        <p class="success-subtitle">Your carousel is now live on LinkedIn</p>
        <a href="https://linkedin.com/feed" class="view-post-btn" target="_blank">View on LinkedIn</a>
        <button class="new-post-btn" onclick="resetAndGoHome()">Create Another</button>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>
  </div>

  <script>
    // ============================================
    // STATE
    // ============================================
    // API_BASE: Update PRODUCTION_API after deploying backend to Railway
    const PRODUCTION_API = 'https://web-production-08a17.up.railway.app';
    const API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:5050'
      : PRODUCTION_API;
    // Use CORS proxy for browser access (needed for API calls from deployed site)
    const CORS_PROXY = 'https://corsproxy.io/?';

    // OpenAI TTS for audio summaries - uses backend proxy for security
    const OPENAI_API_KEY = null; // Moved to backend

    let isAudioPlaying = false;
    let cachedAudioUrl = null;

    // Inspiring quotes for audio intros
    const inspiringQuotes = [
      "As Maya Angelou said, 'There is no greater agony than bearing an untold story inside you.'",
      "In the words of Steve Jobs, 'Innovation distinguishes between a leader and a follower.'",
      "Oscar Wilde reminded us, 'Be yourself; everyone else is already taken.'",
      "As Albert Einstein said, 'Imagination is more important than knowledge.'",
      "In the words of Rumi, 'What you seek is seeking you.'",
      "Marie Curie said, 'Nothing in life is to be feared, it is only to be understood.'",
      "As Walt Disney said, 'The way to get started is to quit talking and begin doing.'",
      "Leonardo da Vinci wrote, 'Learning never exhausts the mind.'",
      "As Nelson Mandela said, 'It always seems impossible until it's done.'",
      "In the words of Coco Chanel, 'In order to be irreplaceable, one must always be different.'"
    ];

    // Audio summary functions - uses backend proxy for API calls
    async function generateAudioSummary(article) {
      const statusEl = document.getElementById('audio-status');
      const btnEl = document.getElementById('audio-btn');
      const iconEl = document.getElementById('audio-icon');
      const textEl = document.getElementById('audio-text');
      const audioEl = document.getElementById('summary-audio');

      if (!article) {
        statusEl.textContent = 'No article selected';
        return;
      }

      statusEl.textContent = 'Generating summary...';
      btnEl.disabled = true;

      try {
        // Get a random inspiring quote
        const quote = inspiringQuotes[Math.floor(Math.random() * inspiringQuotes.length)];

        // Call backend to generate audio summary
        const response = await fetch(`${API_BASE}/audio-summary`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: article.title,
            source: article.source || '',
            summary: article.summary || article.description || '',
            quote: quote
          })
        });

        if (!response.ok) throw new Error('Failed to generate audio');

        statusEl.textContent = 'Loading audio...';
        const audioBlob = await response.blob();
        cachedAudioUrl = URL.createObjectURL(audioBlob);

        audioEl.src = cachedAudioUrl;
        audioEl.play();
        isAudioPlaying = true;

        iconEl.textContent = '⏸️';
        textEl.textContent = 'Pause';
        statusEl.textContent = 'Playing...';

        audioEl.onended = () => {
          isAudioPlaying = false;
          iconEl.textContent = '🎧';
          textEl.textContent = 'Replay';
          statusEl.textContent = 'Ask me anything!';
          // Show mic button for voice chat
          const micBtn = document.getElementById('mic-btn');
          if (micBtn) micBtn.style.display = 'flex';
        };

      } catch (error) {
        console.error('Audio generation error:', error);
        statusEl.textContent = 'Audio unavailable';
      }

      btnEl.disabled = false;
    }

    function toggleAudioSummary() {
      const audioEl = document.getElementById('summary-audio');
      const iconEl = document.getElementById('audio-icon');
      const textEl = document.getElementById('audio-text');
      const statusEl = document.getElementById('audio-status');

      if (!cachedAudioUrl) {
        // Generate new audio
        generateAudioSummary(selectedArticle);
      } else if (isAudioPlaying) {
        // Pause
        audioEl.pause();
        isAudioPlaying = false;
        iconEl.textContent = '▶️';
        textEl.textContent = 'Resume';
        statusEl.textContent = 'Paused';
      } else {
        // Resume or replay
        audioEl.play();
        isAudioPlaying = true;
        iconEl.textContent = '⏸️';
        textEl.textContent = 'Pause';
        statusEl.textContent = 'Playing...';
      }
    }

    function resetAudioState() {
      const iconEl = document.getElementById('audio-icon');
      const textEl = document.getElementById('audio-text');
      const statusEl = document.getElementById('audio-status');
      const audioEl = document.getElementById('summary-audio');

      if (audioEl) {
        audioEl.pause();
        audioEl.src = '';
      }
      if (cachedAudioUrl) {
        URL.revokeObjectURL(cachedAudioUrl);
        cachedAudioUrl = null;
      }
      isAudioPlaying = false;

      if (iconEl) iconEl.textContent = '🎧';
      if (textEl) textEl.textContent = 'Listen';
      if (statusEl) statusEl.textContent = '';
      // Hide mic button on reset
      const micBtn = document.getElementById('mic-btn');
      if (micBtn) micBtn.style.display = 'none';
    }

    // ============================================
    // VOICE CHAT - Interactive Q&A
    // ============================================
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    async function toggleVoiceChat() {
      const micBtn = document.getElementById('mic-btn');
      const micIcon = document.getElementById('mic-icon');
      const micText = document.getElementById('mic-text');
      const statusEl = document.getElementById('audio-status');

      if (isRecording) {
        // Stop recording
        mediaRecorder.stop();
        isRecording = false;
        micIcon.textContent = '🎤';
        micText.textContent = 'Ask';
        micBtn.style.background = 'var(--accent)';
      } else {
        // Start recording
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = (e) => {
            audioChunks.push(e.data);
          };

          mediaRecorder.onstop = async () => {
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());

            // Process recording
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            await sendVoiceQuestion(audioBlob);
          };

          mediaRecorder.start();
          isRecording = true;
          micIcon.textContent = '⏹️';
          micText.textContent = 'Stop';
          micBtn.style.background = '#e74c3c';
          statusEl.textContent = 'Listening...';
        } catch (err) {
          console.error('Mic error:', err);
          statusEl.textContent = 'Mic access denied';
        }
      }
    }

    async function sendVoiceQuestion(audioBlob) {
      const statusEl = document.getElementById('audio-status');
      const responseAudio = document.getElementById('voice-response-audio');

      statusEl.textContent = 'Processing...';

      try {
        // Convert blob to base64
        const reader = new FileReader();
        reader.readAsDataURL(audioBlob);

        reader.onloadend = async () => {
          const base64Audio = reader.result.split(',')[1];

          const response = await fetch(`${API_BASE}/voice-chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              audio: base64Audio,
              title: selectedArticle?.title || '',
              summary: selectedArticle?.summary || selectedArticle?.description || ''
            })
          });

          if (!response.ok) throw new Error('Voice chat failed');

          const data = await response.json();
          statusEl.textContent = `You: "${data.question.substring(0, 30)}..."`;

          // Play response audio
          const audioBytes = Uint8Array.from(atob(data.audio), c => c.charCodeAt(0));
          const blob = new Blob([audioBytes], { type: 'audio/mpeg' });
          const audioUrl = URL.createObjectURL(blob);

          responseAudio.src = audioUrl;
          responseAudio.play();

          responseAudio.onended = () => {
            statusEl.textContent = 'Ask another question!';
            URL.revokeObjectURL(audioUrl);
          };
        };
      } catch (err) {
        console.error('Voice chat error:', err);
        statusEl.textContent = 'Could not process question';
      }
    }

    let articles = [];
    let favorites = JSON.parse(localStorage.getItem('ai-radar-favorites') || '[]');
    let currentCardIndex = 0;
    let selectedArticle = null;
    let selectedLength = 'medium';
    let selectedSources = new Set();
    let selectedTopic = 'artificial intelligence';

    // Global topic keywords for learning and display
    const topicKeywords = ['AI', 'GPT', 'OpenAI', 'Google', 'Microsoft', 'Apple', 'Tesla', 'Crypto', 'Startup', 'Enterprise', 'Cloud', 'Data', 'Robot', 'Quantum', 'Meta', 'Amazon', 'ChatGPT', 'Gemini', 'Claude', 'Machine Learning', 'Deep Learning', 'Neural', 'Nvidia', 'Anthropic'];

    // ============================================
    // LEARNING SYSTEM - Track user preferences
    // ============================================
    // Google Sheets Feedback Storage
    const FEEDBACK_SHEET_GID = '5770604';
    const FEEDBACK_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyCfVoFCmq4jTZrXn6mJ75hWemq99IeiHgtxqbFZ2RLx28VNCkAgZy_Rgv_jERe_vfX/exec';

    let userFeedback = JSON.parse(localStorage.getItem('ai-radar-feedback') || '{"dislikedTopics":{},"dislikedSources":{},"dislikedKeywords":{},"likedTopics":{},"likedSources":{}}');

    // Sync feedback to Google Sheets
    async function syncFeedbackToSheets(action, article, topics, keywords) {
      const feedbackRow = {
        timestamp: new Date().toISOString(),
        action: action, // 'like' or 'dislike'
        articleTitle: article.title,
        articleSource: article.source || '',
        topics: topics.join(', '),
        keywords: (keywords || []).slice(0, 10).join(', '),
        articleId: article.id || ''
      };

      // Try to send to Google Sheets via Apps Script
      try {
        const response = await fetch(FEEDBACK_APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors', // Apps Script requires no-cors
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(feedbackRow)
        });
        console.log('Feedback synced to Sheets:', feedbackRow);
      } catch (err) {
        console.log('Sheets sync failed (offline mode):', err.message);
        // Still works offline via localStorage
      }
    }

    function recordNotInterested(article) {
      // Extract topics from title
      const titleWords = article.title.toUpperCase().split(/\s+/);
      const topics = topicKeywords.filter(t => titleWords.includes(t.toUpperCase()));

      // Increment dislike counts for topics
      topics.forEach(topic => {
        userFeedback.dislikedTopics[topic] = (userFeedback.dislikedTopics[topic] || 0) + 1;
      });

      // Increment dislike for source
      if (article.source) {
        userFeedback.dislikedSources[article.source] = (userFeedback.dislikedSources[article.source] || 0) + 1;
      }

      // Extract key words from title (3+ chars, not common words)
      const stopWords = ['THE', 'AND', 'FOR', 'ARE', 'BUT', 'NOT', 'YOU', 'ALL', 'CAN', 'HER', 'WAS', 'ONE', 'OUR', 'OUT', 'WITH', 'THIS', 'THAT', 'FROM', 'HAVE', 'WILL', 'YOUR', 'WHAT', 'HOW', 'WHY', 'NEW'];
      const keywords = titleWords.filter(w => w.length > 3 && !stopWords.includes(w));
      keywords.forEach(kw => {
        userFeedback.dislikedKeywords[kw] = (userFeedback.dislikedKeywords[kw] || 0) + 1;
      });

      localStorage.setItem('ai-radar-feedback', JSON.stringify(userFeedback));
      console.log('Recorded dislike:', { topics, source: article.source, keywords: keywords.slice(0, 5) });

      // Sync to Google Sheets
      syncFeedbackToSheets('dislike', article, topics, keywords);
    }

    function recordInterested(article) {
      // Extract topics from title
      const titleWords = article.title.toUpperCase().split(/\s+/);
      const topics = topicKeywords.filter(t => titleWords.includes(t.toUpperCase()));

      // Increment like counts for topics
      topics.forEach(topic => {
        userFeedback.likedTopics[topic] = (userFeedback.likedTopics[topic] || 0) + 1;
      });

      // Increment like for source
      if (article.source) {
        userFeedback.likedSources[article.source] = (userFeedback.likedSources[article.source] || 0) + 1;
      }

      localStorage.setItem('ai-radar-feedback', JSON.stringify(userFeedback));
      console.log('Recorded like:', { topics, source: article.source });

      // Sync to Google Sheets
      syncFeedbackToSheets('like', article, topics, []);
    }

    function calculateRelevanceScore(article) {
      let score = 0;
      const titleWords = article.title.toUpperCase().split(/\s+/);
      const topics = topicKeywords.filter(t => titleWords.includes(t.toUpperCase()));

      // Boost for liked topics/sources
      topics.forEach(topic => {
        score += (userFeedback.likedTopics[topic] || 0) * 2;
        score -= (userFeedback.dislikedTopics[topic] || 0) * 3;
      });

      if (article.source) {
        score += (userFeedback.likedSources[article.source] || 0) * 2;
        score -= (userFeedback.dislikedSources[article.source] || 0) * 3;
      }

      // Penalize disliked keywords
      titleWords.forEach(word => {
        if (userFeedback.dislikedKeywords[word] >= 2) {
          score -= userFeedback.dislikedKeywords[word];
        }
      });

      return score;
    }

    function sortArticlesByRelevance(articleList) {
      return articleList.sort((a, b) => {
        const scoreA = calculateRelevanceScore(a);
        const scoreB = calculateRelevanceScore(b);
        return scoreB - scoreA; // Higher scores first
      });
    }

    // ============================================
    // GOOGLE SHEETS INTEGRATION
    // ============================================
    function parseCSV(csvText) {
      const lines = csvText.split('\n');
      const headers = parseCSVLine(lines[0]);
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
          const values = parseCSVLine(lines[i]);
          const row = {};
          headers.forEach((header, idx) => {
            row[header.trim()] = values[idx] || '';
          });
          rows.push(row);
        }
      }
      return rows;
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }


    // ============================================
    // SOURCE SELECTION
    // ============================================
    function toggleSource(source) {
      const btn = document.querySelector(`.source-btn[data-source="${source}"]`);
      if (selectedSources.has(source)) {
        selectedSources.delete(source);
        btn.classList.remove('selected');
      } else {
        selectedSources.add(source);
        btn.classList.add('selected');
      }
      updateFetchButton();
    }

    function setTopic(topic) {
      selectedTopic = topic;
    }

    async function setTopicAndFetchCounts(topic) {
      selectedTopic = topic;

      // Show loading state on all source buttons
      const sources = ['newsapi', 'newsdata', 'perplexity', 'grok'];
      sources.forEach(source => {
        const btn = document.querySelector(`.source-btn[data-source="${source}"]`);
        if (btn) {
          const countEl = btn.querySelector('.count');
          if (countEl) countEl.textContent = '...';
        }
      });

      // Fetch counts for each source (simulated for demo)
      for (const source of sources) {
        await fetchSourceCount(source, topic);
      }
    }

    async function fetchSourceCount(source, topic) {
      const btn = document.querySelector(`.source-btn[data-source="${source}"]`);

      try {
        // Try real backend
        const response = await fetch(`${API_BASE}/api/articles/count?source=${source}&topic=${encodeURIComponent(topic)}`);
        if (response.ok) {
          const data = await response.json();
          btn.querySelector('.count').textContent = data.count || 0;
          return;
        }
      } catch (err) {
        // Demo mode - generate random counts
      }

      // Demo: random article counts
      await sleep(200 + Math.random() * 300);
      const count = Math.floor(Math.random() * 15) + 3;
      btn.querySelector('.count').textContent = count;
    }

    function updateFetchButton() {
      const btn = document.querySelector('.fetch-all-btn');
      const count = selectedSources.size;
      if (count === 0) {
        btn.textContent = 'FETCH ALL SOURCES';
      } else {
        btn.textContent = `FETCH ${count} SOURCE${count > 1 ? 'S' : ''}`;
      }
    }

    // ============================================
    // SCREEN NAVIGATION
    // ============================================
    function showScreen(screenId) {
      // Reset audio when leaving generating screen
      const currentScreen = document.querySelector('.screen.active');
      if (currentScreen && currentScreen.id === 'screen-generating' && screenId !== 'generating') {
        resetAudioState();
      }

      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById('screen-' + screenId).classList.add('active');

      if (screenId === 'swipe') {
        renderCards();
      } else if (screenId === 'favorites') {
        renderFavorites();
      } else if (screenId === 'generating') {
        // Reset audio state when entering generating screen (fresh start)
        resetAudioState();
      }
    }

    // ============================================
    // HOME SCREEN - FETCH SOURCES
    // ============================================
    async function fetchSource(source) {
      const btn = document.querySelector(`.source-btn[data-source="${source}"]`);
      btn.classList.add('fetching');

      // API calls through Vercel serverless routes (no CORS issues)
      try {
        let directArticles = [];

        if (source === 'newsapi') {
          const resp = await fetch(`/api/newsapi?q=${encodeURIComponent(selectedTopic)}&pageSize=10`);
          const data = await resp.json();
          if (data.articles) {
            directArticles = data.articles.map(a => ({
              id: Date.now() + Math.random(),
              title: a.title,
              summary: a.description || '',
              url: a.url,
              image: a.urlToImage,
              source: 'newsapi',
              publishedAt: a.publishedAt,
              date: formatDate(a.publishedAt),
              avgScore: (70 + Math.random() * 25).toFixed(1)
            }));
          }
        } else if (source === 'newsdata') {
          const resp = await fetch(`/api/newsdata?q=${encodeURIComponent(selectedTopic)}&language=en`);
          const data = await resp.json();
          if (data.results) {
            directArticles = data.results.map(a => ({
              id: Date.now() + Math.random(),
              title: a.title,
              summary: a.description || '',
              url: a.link,
              image: a.image_url,
              source: 'newsdata',
              publishedAt: a.pubDate,
              date: formatDate(a.pubDate),
              avgScore: (70 + Math.random() * 25).toFixed(1)
            }));
          }
        } else if (source === 'perplexity') {
          const resp = await fetch('/api/perplexity', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model: 'sonar',
              messages: [{
                role: 'user',
                content: `Find 5 recent news articles about ${selectedTopic}. Return JSON array with objects having: title, summary, url, publishedAt (ISO date). Only return the JSON array, no other text.`
              }]
            })
          });
          const data = await resp.json();
          if (data.choices?.[0]?.message?.content) {
            try {
              const parsed = JSON.parse(data.choices[0].message.content);
              directArticles = parsed.map(a => ({
                id: Date.now() + Math.random(),
                title: a.title,
                summary: a.summary || '',
                url: a.url,
                source: 'perplexity',
                publishedAt: a.publishedAt,
                date: formatDate(a.publishedAt || new Date().toISOString()),
                avgScore: (70 + Math.random() * 25).toFixed(1)
              }));
            } catch (e) { console.log('Perplexity parse error:', e); }
          }
        } else if (source === 'grok') {
          const resp = await fetch('/api/grok', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model: 'grok-3-mini',
              messages: [{
                role: 'user',
                content: `Find 5 recent news articles about ${selectedTopic}. Return JSON array with objects having: title, summary, url, publishedAt (ISO date). Only return the JSON array, no other text.`
              }]
            })
          });
          const data = await resp.json();
          if (data.choices?.[0]?.message?.content) {
            try {
              let content = data.choices[0].message.content;
              // Strip markdown code fences if present
              content = content.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '');
              const parsed = JSON.parse(content);
              directArticles = parsed.map(a => ({
                id: Date.now() + Math.random(),
                title: a.title,
                summary: a.summary || '',
                url: a.url,
                source: 'grok',
                publishedAt: a.publishedAt,
                date: formatDate(a.publishedAt || new Date().toISOString()),
                avgScore: (70 + Math.random() * 25).toFixed(1)
              }));
            } catch (e) { console.log('Grok parse error:', e); }
          }
        }

        if (directArticles.length > 0) {
          articles = [...articles, ...directArticles];
          btn.classList.remove('fetching');
          btn.classList.add('done');
          btn.querySelector('.count').textContent = directArticles.length;
          console.log(`Got ${directArticles.length} articles directly from ${source}`);
          return directArticles.length;
        }
      } catch (err) {
        console.log(`API call failed for ${source}:`, err);
      }

      // Fallback to demo data
      btn.classList.remove('fetching');
      const fakeArticles = generateFakeArticles(source, 5);
      articles = [...articles, ...fakeArticles];
      btn.querySelector('.count').textContent = fakeArticles.length;
      btn.classList.add('done');

      return fakeArticles.length;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    async function fetchAllSources() {
      const btn = document.querySelector('.fetch-all-btn');
      btn.disabled = true;
      btn.textContent = 'FETCHING...';

      const allSources = ['newsapi', 'newsdata', 'perplexity', 'grok'];
      const sources = selectedSources.size > 0 ? Array.from(selectedSources) : allSources;

      for (const source of sources) {
        await fetchSource(source);
        await sleep(300);
      }

      btn.textContent = `${articles.length} ARTICLES READY`;

      // Brief pause then show scoring
      await sleep(500);

      // Show AI scoring animation screen
      showScreen('scoring');

      try {
        await runAIScoringAnimation();
      } catch (err) {
        console.error('Scoring animation error:', err);
      }

      // Sort articles by combined score (AI score + user preference learning)
      try {
        articles.sort((a, b) => {
          const relevanceA = calculateRelevanceScore(a) || 0;
          const relevanceB = calculateRelevanceScore(b) || 0;
          const combinedA = (parseFloat(a.avgScore) || 0) + (relevanceA * 5);
          const combinedB = (parseFloat(b.avgScore) || 0) + (relevanceB * 5);
          return combinedB - combinedA;
        });
        console.log('Articles sorted by learning + AI scores');
      } catch (sortErr) {
        console.error('Sort error:', sortErr);
      }

      // Show swipe screen
      console.log('Transitioning to swipe screen with', articles.length, 'articles');
      showScreen('swipe');
    }

    async function runAIScoringAnimation() {
      const aiModels = ['gpt', 'claude', 'gemini', 'grok', 'pplx'];
      const statusEl = document.getElementById('scoring-status');
      const countEl = document.getElementById('scoring-count');

      if (!statusEl || !countEl) {
        console.error('Scoring elements not found');
        return;
      }

      // Reset all logos to dim
      aiModels.forEach(ai => {
        const el = document.getElementById(`score-${ai}`);
        if (el) el.style.opacity = '0.3';
      });

      // Animate each AI logo turning green (faster animation)
      for (let i = 0; i < aiModels.length; i++) {
        const ai = aiModels[i];
        const aiNames = { gpt: 'ChatGPT', claude: 'Claude', gemini: 'Gemini', grok: 'Grok', pplx: 'Perplexity' };

        statusEl.textContent = `${aiNames[ai]} analyzing...`;

        await sleep(400); // Faster

        // Light up this AI logo
        const el = document.getElementById(`score-${ai}`);
        if (el) {
          el.style.opacity = '1';
          el.style.transform = 'scale(1.1)';
          setTimeout(() => el.style.transform = 'scale(1)', 200);
        }

        countEl.textContent = `${Math.round(((i + 1) / aiModels.length) * articles.length)} articles scored`;
      }

      statusEl.textContent = 'Complete! Ranking by score...';
      await sleep(500); // Faster
      console.log('Scoring animation complete');
    }

    function generateFakeArticles(source, count) {
      const articles = [
        {
          title: 'OpenAI Announces GPT-5 Preview for Enterprise Customers',
          summary: 'The next generation language model promises significant improvements in reasoning and code generation capabilities. Early testers report 40% better performance on complex multi-step tasks and near-human level understanding of nuanced instructions.',
          image: 'https://images.unsplash.com/photo-1677442136019-21780ecad995?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Major AI milestone, high engagement expected',
            claude: 'Significant industry impact, well-documented',
            gemini: 'Competitive landscape shift, viral potential',
            grok: 'Trending #1 on tech Twitter right now',
            pplx: 'Confirmed by multiple tier-1 sources'
          }
        },
        {
          title: 'Apple Reveals New AI Features Coming to iOS 19',
          summary: 'Siri gets a major upgrade with on-device LLM processing and new contextual awareness features. The update includes real-time translation, smart summarization, and predictive actions based on user habits.',
          image: 'https://images.unsplash.com/photo-1611532736597-de2d4265fba3?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Mass market appeal, affects billions',
            claude: 'Privacy-focused approach is newsworthy',
            gemini: 'Strong visual content opportunity',
            grok: 'Apple fans highly engaged on this',
            pplx: 'Official Apple announcement verified'
          }
        },
        {
          title: 'Google DeepMind Achieves Breakthrough in Protein Folding',
          summary: 'AlphaFold 3 can now predict protein interactions with unprecedented accuracy, accelerating drug discovery. Researchers say this could cut drug development timelines by years and save billions in R&D costs.',
          image: 'https://images.unsplash.com/photo-1532187863486-abf9dbad1b69?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Scientific breakthrough with real-world impact',
            claude: 'Healthcare implications are profound',
            gemini: 'Google property, have insider context',
            grok: 'Science community buzzing about this',
            pplx: 'Peer-reviewed research backing claims'
          }
        },
        {
          title: 'Microsoft Copilot Now Available in All Office Apps',
          summary: 'AI-powered assistance comes to Word, Excel, PowerPoint and Outlook for all Microsoft 365 subscribers. The rollout marks the largest enterprise AI deployment in history, touching 400M+ users.',
          image: 'https://images.unsplash.com/photo-1633419461186-7d40a38105ec?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Enterprise AI adoption accelerating',
            claude: 'Productivity implications significant',
            gemini: 'Direct competitor move, important',
            grok: 'Business Twitter loves productivity tools',
            pplx: 'Microsoft official blog confirmed'
          }
        },
        {
          title: 'Meta Launches New Open Source LLM for Developers',
          summary: 'Llama 4 offers state-of-the-art performance with full commercial usage rights and no API costs. Benchmarks show it outperforms GPT-4 on coding tasks while being completely free to use.',
          image: 'https://images.unsplash.com/photo-1611162617474-5b21e879e113?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Open source AI is reshaping the industry',
            claude: 'Democratization of AI is key theme',
            gemini: 'Competitive threat assessment needed',
            grok: 'Dev community extremely excited',
            pplx: 'Benchmarks independently verified'
          }
        },
        {
          title: 'NVIDIA Reports Record Revenue from AI Chip Demand',
          summary: 'Data center GPU sales surge 400% as companies race to build AI infrastructure. The company now holds 95% market share in AI training chips, with demand outpacing supply through 2025.',
          image: 'https://images.unsplash.com/photo-1591799264318-7e6ef8ddb7ea?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Infrastructure story underlies all AI',
            claude: 'Market dynamics worth analyzing',
            gemini: 'Financial implications substantial',
            grok: 'Stock traders very engaged on this',
            pplx: 'SEC filings confirm numbers'
          }
        },
        {
          title: 'Amazon AWS Introduces New AI Training Services',
          summary: 'Bedrock platform expands with custom model fine-tuning and new foundation model options. Enterprise customers can now train proprietary models on their own data with full privacy guarantees.',
          image: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Cloud AI competition heating up',
            claude: 'Enterprise AI needs are evolving',
            gemini: 'Multi-cloud strategy implications',
            grok: 'AWS re:Invent always trends big',
            pplx: 'AWS documentation confirms features'
          }
        },
        {
          title: 'Tesla FSD V13 Achieves Level 4 Autonomy Certification',
          summary: 'Regulatory approval marks milestone for self-driving technology deployment at scale. Tesla vehicles can now operate without human supervision in approved geofenced areas across 12 US states.',
          image: 'https://images.unsplash.com/photo-1560958089-b8a1929cea89?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Autonomous vehicles reaching inflection',
            claude: 'Safety and regulatory angle important',
            gemini: 'Transportation revolution underway',
            grok: 'Elon content always goes viral',
            pplx: 'NHTSA approval docs verified'
          }
        }
      ];

      const dates = ['Today', 'Yesterday', '2 days ago', 'Jan 10', 'Jan 9', 'Jan 8'];
      const pages = [2, 3, 4, 5, 6, 7];

      return Array.from({length: count}, (_, i) => {
        const article = articles[Math.floor(Math.random() * articles.length)];
        return {
          id: Date.now() + i + Math.random(),
          title: article.title,
          source: source,
          summary: article.summary,
          image: article.image,
          date: dates[Math.floor(Math.random() * dates.length)],
          pages: pages[Math.floor(Math.random() * pages.length)],
          words: Math.floor(Math.random() * 1500) + 500, // 500-2000 words (always >= 500)
          rationales: article.rationales,
          scores: {
            gpt: Math.floor(Math.random() * 3) + 7,
            claude: Math.floor(Math.random() * 3) + 7,
            gemini: Math.floor(Math.random() * 3) + 7,
            grok: Math.floor(Math.random() * 3) + 7,
            pplx: Math.floor(Math.random() * 3) + 7
          },
          avgScore: (Math.random() * 2 + 7).toFixed(1)
        };
      });
    }

    // ============================================
    // SWIPE CARDS
    // ============================================
    function renderCards() {
      const stack = document.getElementById('card-stack');
      const remaining = articles.length - currentCardIndex;

      // Update card counter
      const currentNum = currentCardIndex + 1;
      const totalNum = articles.length;
      document.getElementById('swipe-card-counter').innerHTML =
        `Card <span>${Math.min(currentNum, totalNum)}</span> of <span>${totalNum}</span>`;

      // Clear existing cards
      stack.querySelectorAll('.swipe-card').forEach(c => c.remove());

      if (remaining === 0) {
        showToast('No more articles!');
        document.getElementById('swipe-card-counter').innerHTML =
          `Card <span>${totalNum}</span> of <span>${totalNum}</span> - Done!`;
        return;
      }

      // Show up to 3 cards
      for (let i = 0; i < Math.min(3, remaining); i++) {
        const article = articles[currentCardIndex + i];
        const card = createCard(article, i);
        stack.appendChild(card);
      }

      // Setup swipe on top card
      setupSwipe(stack.querySelector('.swipe-card'));
    }

    function createCard(article, stackIndex) {
      const card = document.createElement('div');
      card.className = 'swipe-card';
      card.style.zIndex = 10 - stackIndex;
      // More visible stack effect - scale down and offset each card
      card.style.transform = `scale(${1 - stackIndex * 0.06}) translateY(${stackIndex * 15}px)`;
      card.style.opacity = stackIndex === 0 ? '1' : `${1 - stackIndex * 0.15}`;
      card.dataset.id = article.id;

      // Use article image or generate a placeholder
      const imageUrl = article.image || `https://picsum.photos/400/200?random=${article.id}`;

      // Extract key topics from title/summary
      const titleWords = (article.title + ' ' + article.summary).toUpperCase();
      const topics = topicKeywords.filter(t => titleWords.includes(t.toUpperCase())).slice(0, 3);
      if (topics.length === 0) topics.push('Tech', 'News');

      // Use actual word count from data (don't estimate)
      const wordCount = article.words || 0;

      // Card position info
      const cardNum = currentCardIndex + stackIndex + 1;
      const totalCards = articles.length;

      // Get individual scores (convert to percentages)
      const scores = article.scores || {};
      const gptScore = Math.round((scores.gpt || Math.floor(Math.random() * 3) + 7) * 10);
      const claudeScore = Math.round((scores.claude || Math.floor(Math.random() * 3) + 7) * 10);
      const geminiScore = Math.round((scores.gemini || Math.floor(Math.random() * 3) + 7) * 10);
      const grokScore = Math.round((scores.grok || Math.floor(Math.random() * 3) + 7) * 10);
      const pplxScore = Math.round((scores.pplx || Math.floor(Math.random() * 3) + 7) * 10);

      card.innerHTML = `
        <div class="card-image" style="background-image: url('${imageUrl}')">
          <div style="position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.6); color: white; padding: 3px 8px; border-radius: 10px; font-weight: 600; font-size: 10px;">
            ${cardNum}/${totalCards}
          </div>
        </div>
        <div class="card-body">
          <div class="card-source">${article.source}</div>
          <h2 class="card-title">${article.title}</h2>
          <div class="card-topics">
            ${topics.map(t => `<span class="card-topic">${t}</span>`).join('')}
          </div>
          <div class="card-meta">
            <span>${article.date || 'Today'}</span>
            <span>${wordCount}w</span>
          </div>
          <div class="ai-scores-section">
            <div style="text-align: center; margin-bottom: 6px;">
              <span style="font-size: 18px; font-weight: 700; color: var(--gold);">${Math.round(parseFloat(article.avgScore) * 10)}%</span>
              <span style="font-size: 10px; color: #888; margin-left: 4px;">avg</span>
            </div>
            <div style="display: flex; justify-content: space-around; gap: 4px;">
              <div class="ai-score-item" data-ai="gpt" data-score="${gptScore}" data-article-id="${article.id}" style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                <img src="logos/chatgpt.png" style="width:20px;height:20px;border-radius:50%;">
                <span style="font-size: 10px; font-weight: 600; color: #333; margin-top: 2px;">${gptScore}</span>
              </div>
              <div class="ai-score-item" data-ai="claude" data-score="${claudeScore}" data-article-id="${article.id}" style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                <img src="logos/claude.png" style="width:20px;height:20px;border-radius:50%;">
                <span style="font-size: 10px; font-weight: 600; color: #333; margin-top: 2px;">${claudeScore}</span>
              </div>
              <div class="ai-score-item" data-ai="gemini" data-score="${geminiScore}" data-article-id="${article.id}" style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                <img src="logos/gemini.png" style="width:20px;height:20px;border-radius:50%;">
                <span style="font-size: 10px; font-weight: 600; color: #333; margin-top: 2px;">${geminiScore}</span>
              </div>
              <div class="ai-score-item" data-ai="grok" data-score="${grokScore}" data-article-id="${article.id}" style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                <img src="logos/grok.png" style="width:20px;height:20px;border-radius:50%;background:#333;">
                <span style="font-size: 10px; font-weight: 600; color: #333; margin-top: 2px;">${grokScore}</span>
              </div>
              <div class="ai-score-item" data-ai="pplx" data-score="${pplxScore}" data-article-id="${article.id}" style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                <img src="logos/perplexity.png" style="width:20px;height:20px;border-radius:50%;background:#fff;">
                <span style="font-size: 10px; font-weight: 600; color: #333; margin-top: 2px;">${pplxScore}</span>
              </div>
            </div>
          </div>
        </div>
      `;

      // Add double-click handlers for individual AI scores
      card.querySelectorAll('.ai-score-item').forEach(item => {
        item.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          const ai = item.dataset.ai;
          const score = item.dataset.score;
          const articleId = item.dataset.articleId;
          showAIScoreDetail(ai, score, articleId, article);
        });
      });

      return card;
    }

    // Show AI score detail popup
    function showAIScoreDetail(ai, score, articleId, article) {
      const aiNames = {
        gpt: 'ChatGPT',
        claude: 'Claude',
        gemini: 'Gemini',
        grok: 'Grok',
        pplx: 'Perplexity'
      };
      const rationales = article.rationales || {};
      const rationale = rationales[ai] || `${aiNames[ai]} scored this article ${score}% based on relevance, timeliness, and industry impact.`;

      // Create popup
      const popup = document.createElement('div');
      popup.className = 'ai-detail-popup';
      popup.innerHTML = `
        <div class="ai-detail-content">
          <div class="ai-detail-header">
            <img src="logos/${ai === 'pplx' ? 'perplexity' : ai}.png" style="width: 40px; height: 40px; border-radius: 50%; ${ai === 'grok' ? 'background:#333;' : ai === 'pplx' ? 'background:#fff;' : ''}">
            <div>
              <h3 style="margin: 0; color: var(--gold);">${aiNames[ai]}</h3>
              <span style="font-size: 24px; font-weight: 700;">${score}%</span>
            </div>
          </div>
          <p class="ai-detail-rationale">${rationale}</p>
          <button class="ai-detail-close" onclick="this.closest('.ai-detail-popup').remove()">Close</button>
        </div>
      `;
      document.body.appendChild(popup);
    }

    function setupSwipe(card) {
      if (!card) return;

      let startX = 0, startY = 0;
      let currentX = 0, currentY = 0;
      let isDragging = false;

      card.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        isDragging = true;
        card.classList.add('dragging');
      });

      card.addEventListener('touchmove', (e) => {
        if (!isDragging) return;

        currentX = e.touches[0].clientX - startX;
        currentY = e.touches[0].clientY - startY;

        const rotation = currentX * 0.1;
        card.style.transform = `translate(${currentX}px, ${currentY}px) rotate(${rotation}deg)`;

        // Show indicators
        const threshold = 50;
        document.querySelector('.swipe-indicator.left').style.opacity = currentX < -threshold ? 1 : 0;
        document.querySelector('.swipe-indicator.right').style.opacity = currentX > threshold ? 1 : 0;
        document.querySelector('.swipe-indicator.up').style.opacity = currentY < -threshold ? 1 : 0;
        document.querySelector('.swipe-indicator.down').style.opacity = currentY > threshold ? 1 : 0;
      });

      card.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;
        card.classList.remove('dragging');

        // Hide indicators
        document.querySelectorAll('.swipe-indicator').forEach(i => i.style.opacity = 0);

        const threshold = 100;
        const absX = Math.abs(currentX);
        const absY = Math.abs(currentY);

        if (absX > threshold || absY > threshold) {
          if (absX > absY) {
            // Horizontal swipe
            if (currentX > 0) {
              handleSwipe('right', card);
            } else {
              handleSwipe('left', card);
            }
          } else {
            // Vertical swipe
            if (currentY < 0) {
              handleSwipe('up', card);
            } else {
              handleSwipe('down', card);
            }
          }
        } else {
          // Check if it was a tap (minimal movement)
          if (absX < 10 && absY < 10) {
            const articleId = parseFloat(card.dataset.id);
            const article = articles.find(a => a.id === articleId);
            if (article) {
              showArticleModal(article);
            }
          }
          // Reset position
          card.style.transform = '';
        }

        currentX = 0;
        currentY = 0;
      });

      // Mouse support for desktop
      card.addEventListener('mousedown', (e) => {
        startX = e.clientX;
        startY = e.clientY;
        isDragging = true;
        card.classList.add('dragging');
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        currentX = e.clientX - startX;
        currentY = e.clientY - startY;

        const rotation = currentX * 0.1;
        card.style.transform = `translate(${currentX}px, ${currentY}px) rotate(${rotation}deg)`;
      });

      document.addEventListener('mouseup', () => {
        if (!isDragging) return;
        isDragging = false;
        card.classList.remove('dragging');

        const threshold = 100;
        const absX = Math.abs(currentX);
        const absY = Math.abs(currentY);

        if (absX > threshold || absY > threshold) {
          if (absX > absY) {
            if (currentX > 0) handleSwipe('right', card);
            else handleSwipe('left', card);
          } else {
            if (currentY < 0) handleSwipe('up', card);
            else handleSwipe('down', card);
          }
        } else {
          // Check if it was a click (minimal movement)
          if (absX < 10 && absY < 10) {
            const articleId = parseFloat(card.dataset.id);
            const article = articles.find(a => a.id === articleId);
            if (article) {
              showArticleModal(article);
            }
          }
          card.style.transform = '';
        }

        currentX = 0;
        currentY = 0;
      });
    }

    function handleSwipe(direction, card) {
      const articleId = parseFloat(card.dataset.id);
      const article = articles.find(a => a.id === articleId);

      // Animate card out
      let exitX = 0, exitY = 0;
      switch(direction) {
        case 'right':
          // CREATE - Show length selection modal & record positive feedback
          selectedArticle = article;
          recordInterested(article);
          showLengthModal();
          // Reset card position
          card.style.transform = '';
          return; // Don't animate out
        case 'left':
          exitX = -window.innerWidth;
          showToast('Skipped');
          break;
        case 'up':
          // NOT INTERESTED - Delete and learn
          exitY = -window.innerHeight;
          recordNotInterested(article);
          showToast('Not interested 👎');
          break;
        case 'down':
          // GO BACK - Return to source list
          exitY = window.innerHeight;
          showToast('Back to sources');
          card.style.transition = 'transform 0.3s ease';
          card.style.transform = `translateY(${exitY}px)`;
          setTimeout(() => {
            showScreen('home');
          }, 300);
          return; // Don't continue to next card
      }

      card.style.transition = 'transform 0.3s ease';
      card.style.transform = `translate(${exitX}px, ${exitY}px) rotate(${exitX * 0.05}deg)`;

      setTimeout(() => {
        currentCardIndex++;
        renderCards();
      }, 300);
    }

    function addToFavorites(article) {
      if (!favorites.find(f => f.id === article.id)) {
        favorites.unshift(article);
        localStorage.setItem('ai-radar-favorites', JSON.stringify(favorites));
        updateFavCount();
      }
    }

    function updateFavCount() {
      document.getElementById('fav-count').textContent = favorites.length;
    }

    // SAVE FOR LATER
    let savedForLater = JSON.parse(localStorage.getItem('ai-radar-saved') || '[]');

    function addToSavedForLater(article) {
      if (!savedForLater.find(s => s.id === article.id)) {
        savedForLater.unshift({
          ...article,
          savedAt: new Date().toISOString()
        });
        localStorage.setItem('ai-radar-saved', JSON.stringify(savedForLater));
        updateSavedCount();
      }
    }

    function updateSavedCount() {
      const countEl = document.getElementById('fav-count');
      if (countEl) countEl.textContent = savedForLater.length;
    }

    // ============================================
    // ARTICLE DETAIL MODAL
    // ============================================
    function showArticleModal(article) {
      const modal = document.getElementById('article-modal');

      // Populate modal
      const imageUrl = article.image || `https://picsum.photos/400/200?random=${article.id}`;
      document.getElementById('modal-image').style.backgroundImage = `url('${imageUrl}')`;
      document.getElementById('modal-source').textContent = article.source;
      document.getElementById('modal-title').textContent = article.title;
      document.getElementById('modal-date').textContent = article.date || 'Today';
      document.getElementById('modal-pages').textContent = `${article.pages || 3} pages`;
      document.getElementById('modal-description').textContent = article.summary;
      document.getElementById('modal-score').textContent = Math.round(parseFloat(article.avgScore) * 10) + '%';

      // Generate AI consensus text - each on its own line (scores as percentages)
      const consensusTexts = [
        `<strong>GPT</strong> (${Math.round((article.scores?.gpt || 8) * 10)}%): ${article.rationales?.gpt || 'High relevance score'}`,
        `<strong>Claude</strong> (${Math.round((article.scores?.claude || 8) * 10)}%): ${article.rationales?.claude || 'Well-sourced content'}`,
        `<strong>Gemini</strong> (${Math.round((article.scores?.gemini || 8) * 10)}%): ${article.rationales?.gemini || 'Good engagement potential'}`,
        `<strong>Grok</strong> (${Math.round((article.scores?.grok || 8) * 10)}%): ${article.rationales?.grok || 'Trending topic'}`,
        `<strong>Perplexity</strong> (${Math.round((article.scores?.pplx || 8) * 10)}%): ${article.rationales?.pplx || 'Multiple sources verified'}`
      ];
      document.getElementById('modal-consensus').innerHTML = consensusTexts.join('<br>');

      modal.classList.add('show');
    }

    function hideArticleModal() {
      document.getElementById('article-modal').classList.remove('show');
    }

    // ============================================
    // LENGTH MODAL
    // ============================================
    function showLengthModal() {
      document.getElementById('length-modal').classList.add('show');
    }

    function hideLengthModal() {
      document.getElementById('length-modal').classList.remove('show');
    }

    // Gamma Template IDs for different presentation lengths
    const GAMMA_TEMPLATES = {
      short: 'g_u47ie8xrqvrhirk',
      medium: 'g_mcymorivaww6g9a',
      long: 'g_cerf2t2ar1x2nt8'
    };

    // Card configurations for each length
    const CARD_CONFIGS = {
      short: {
        count: 6,
        steps: [
          { icon: '🎯', step: 'Title Card' },
          { icon: '📊', step: 'Key Stats' },
          { icon: '💡', step: 'Main Insight' },
          { icon: '🔍', step: 'Analysis' },
          { icon: '📈', step: 'Impact' },
          { icon: '🎬', step: 'Call to Action' }
        ]
      },
      medium: {
        count: 12,
        steps: [
          { icon: '🎯', step: 'Title Card' },
          { icon: '📰', step: 'News Hook' },
          { icon: '📊', step: 'Key Stats' },
          { icon: '💡', step: 'Main Insight' },
          { icon: '🔍', step: 'Deep Dive' },
          { icon: '🧠', step: 'AI Analysis' },
          { icon: '📈', step: 'Market Impact' },
          { icon: '🏢', step: 'Industry View' },
          { icon: '⚡', step: 'Quick Takes' },
          { icon: '🔮', step: 'Future Outlook' },
          { icon: '💼', step: 'Action Items' },
          { icon: '🎬', step: 'Call to Action' }
        ]
      },
      long: {
        count: 20,
        steps: [
          { icon: '🎯', step: 'Title Card' },
          { icon: '📰', step: 'Breaking News' },
          { icon: '📋', step: 'Executive Summary' },
          { icon: '📊', step: 'Key Statistics' },
          { icon: '💡', step: 'Core Insight' },
          { icon: '🔍', step: 'Deep Analysis' },
          { icon: '🧠', step: 'AI Perspective' },
          { icon: '📈', step: 'Market Trends' },
          { icon: '🏢', step: 'Industry Impact' },
          { icon: '🌐', step: 'Global Context' },
          { icon: '⚡', step: 'Quick Facts' },
          { icon: '👥', step: 'Stakeholders' },
          { icon: '💰', step: 'Financial View' },
          { icon: '🔮', step: 'Predictions' },
          { icon: '⚠️', step: 'Risks & Challenges' },
          { icon: '🎯', step: 'Opportunities' },
          { icon: '📝', step: 'Expert Quotes' },
          { icon: '💼', step: 'Action Items' },
          { icon: '📚', step: 'Resources' },
          { icon: '🎬', step: 'Call to Action' }
        ]
      }
    };

    // AI Commentary messages for different stages
    const AI_COMMENTARY = [
      "Analyzing the article structure and identifying key points...",
      "Extracting the most impactful statistics and data...",
      "Crafting compelling visual narratives...",
      "Optimizing content for LinkedIn engagement...",
      "Applying your brand template styling...",
      "Generating professional slide layouts...",
      "Fine-tuning typography and spacing...",
      "Adding visual hierarchy and emphasis...",
      "Reviewing for maximum professional impact...",
      "Almost there! Finalizing your carousel..."
    ];

    let currentJobId = null;
    let generationPollInterval = null;

    function selectLengthAndGenerate(length) {
      selectedLength = length;
      hideLengthModal();

      // Animate out the current card
      const card = document.querySelector('.swipe-card');
      if (card) {
        card.style.transition = 'transform 0.3s ease';
        card.style.transform = `translateY(-${window.innerHeight}px)`;
      }

      setTimeout(() => {
        currentCardIndex++;
        startCardGeneration(length);
      }, 300);
    }

    async function startCardGeneration(length) {
      const config = CARD_CONFIGS[length];
      console.log('Starting generation with config:', length, config);

      // Show generating screen
      showScreen('generating');

      // Lazy load audio summary after a few seconds (gives time for UI to settle)
      setTimeout(() => {
        if (selectedArticle && !isAudioPlaying) {
          console.log('Lazy loading audio summary...');
          document.getElementById('audio-status').textContent = 'Preparing audio...';
          generateAudioSummary(selectedArticle);
        }
      }, 3000); // 3 second delay for lazy load effect

      // Set up single card display
      document.getElementById('step-num').textContent = '1';
      document.getElementById('step-total').textContent = `of ${config.count}`;
      document.getElementById('gen-step-description').textContent = config.steps[0]?.step || 'Starting...';
      document.getElementById('generating-status').textContent = 'Creating carousel...';

      // Reset progress
      document.getElementById('gen-progress-fill').style.width = '0%';
      document.getElementById('gen-percent').textContent = '0%';

      // Try to call real backend first
      try {
        console.log('Calling backend to generate slides (preview mode)...');
        const response = await fetch(`${API_BASE}/generate-from-newsout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: selectedArticle.title,
            summary: selectedArticle.summary || selectedArticle.description || '',
            source: selectedArticle.source || '',
            link: selectedArticle.link || selectedArticle.url || '',
            avg_score: selectedArticle.avg_score || 85,
            preview_only: true  // Generate but don't post - let user review first
          })
        });

        if (response.ok) {
          const data = await response.json();
          currentJobId = data.job_id;
          console.log('Backend job started:', currentJobId);
          document.getElementById('generating-status').textContent = 'Generating with Gamma AI...';
          startGenerationPolling(config.count);
          return;
        }
      } catch (err) {
        console.log('Backend not available, using simulation:', err);
      }

      // Fallback to simulation if backend unavailable
      console.log('Running simulation with', config.count, 'cards');
      runGenerationSimulation(config.count);
    }

    function startGenerationPolling(cardCount) {
      let lastPercent = 0;
      let lastStep = 0;
      const config = CARD_CONFIGS[Object.keys(CARD_CONFIGS).find(k => CARD_CONFIGS[k].count === cardCount)] || CARD_CONFIGS.medium;

      generationPollInterval = setInterval(async () => {
        try {
          const response = await fetch(`${API_BASE}/status/${currentJobId}`);
          const status = await response.json();

          const percent = status.percent || 0;

          // Update progress
          document.getElementById('gen-progress-fill').style.width = `${percent}%`;
          document.getElementById('gen-percent').textContent = `${percent}%`;

          // Update single card step
          const currentStep = Math.min(Math.floor((percent / 100) * cardCount) + 1, cardCount);
          if (currentStep !== lastStep) {
            updateStepCard(currentStep, cardCount, config);
            lastStep = currentStep;
          }

          lastPercent = percent;

          // Check completion - backend returns "completed", "posted", or "ready_for_review"
          if (status.status === 'complete' || status.status === 'completed' || status.status === 'posted' || status.status === 'ready_for_review') {
            clearInterval(generationPollInterval);
            const isPreview = status.status === 'ready_for_review';
            document.getElementById('gen-step-description').textContent = isPreview ? 'Ready for review!' : 'Complete!';
            console.log('Generation complete! Slides:', status.slides?.length || 0, 'Preview:', isPreview);

            setTimeout(() => {
              showResultsScreen(status, isPreview);
            }, 1000);
          } else if (status.status === 'error' || status.status === 'failed') {
            clearInterval(generationPollInterval);
            document.getElementById('gen-step-description').textContent = 'Error - trying simulation...';
            showToast('Backend failed, using demo mode');
            console.log('Backend failed, falling back to simulation');
            // Fall back to simulation
            setTimeout(() => {
              runGenerationSimulation(cardCount);
            }, 1000);
          }

        } catch (error) {
          console.error('Polling error:', error);
        }
      }, 1000);
    }

    function updateStepCard(step, total, config) {
      const stepNumEl = document.getElementById('step-num');
      const stepDescEl = document.getElementById('gen-step-description');

      // Animate the number change
      stepNumEl.style.transform = 'scale(1.2)';
      stepNumEl.textContent = step;

      setTimeout(() => {
        stepNumEl.style.transform = 'scale(1)';
      }, 150);

      // Animate description change
      const stepInfo = config.steps[step - 1];
      if (stepInfo) {
        stepDescEl.style.opacity = '0';
        setTimeout(() => {
          stepDescEl.textContent = stepInfo.step;
          stepDescEl.style.opacity = '1';
        }, 100);
      }
    }

    function runGenerationSimulation(cardCount) {
      console.log('Simulation starting for', cardCount, 'cards');
      let percent = 0;
      let lastStep = 0;

      // Find config by count
      let config = CARD_CONFIGS.medium;
      if (cardCount === 6) config = CARD_CONFIGS.short;
      else if (cardCount === 20) config = CARD_CONFIGS.long;

      console.log('Using config:', config);

      // Simulate progress - slower to let audio summary play
      const interval = setInterval(() => {
        percent += Math.random() * 4 + 2; // Random progress 2-6% (slower)
        if (percent > 100) percent = 100;

        // Update progress bar
        const progressFill = document.getElementById('gen-progress-fill');
        const percentText = document.getElementById('gen-percent');
        if (progressFill) progressFill.style.width = `${Math.round(percent)}%`;
        if (percentText) percentText.textContent = `${Math.round(percent)}%`;

        // Update single card step
        const currentStep = Math.min(Math.floor((percent / 100) * cardCount) + 1, cardCount);
        if (currentStep !== lastStep) {
          console.log('Step:', currentStep, 'of', cardCount);
          updateStepCard(currentStep, cardCount, config);
          lastStep = currentStep;
        }

        // Complete
        if (percent >= 100) {
          console.log('Simulation complete!');
          clearInterval(interval);
          const descEl = document.getElementById('gen-step-description');
          if (descEl) descEl.textContent = 'Complete!';

          setTimeout(() => {
            showResultsScreen({ status: 'complete' });
          }, 500);
        }
      }, 500); // Slower - gives time for audio
    }

    // ============================================
    // DETAIL SCREEN
    // ============================================
    function showDetailScreen(article) {
      selectedArticle = article;

      // Set image
      const imageUrl = article.image || `https://picsum.photos/400/200?random=${article.id}`;
      document.getElementById('detail-image').style.backgroundImage = `url('${imageUrl}')`;

      document.getElementById('detail-source').textContent = article.source;
      document.getElementById('detail-title').textContent = article.title;
      document.getElementById('detail-summary').textContent = article.summary;

      document.getElementById('score-gpt').textContent = Math.round((article.scores?.gpt || 8) * 10) + '%';
      document.getElementById('score-claude').textContent = Math.round((article.scores?.claude || 8) * 10) + '%';
      document.getElementById('score-gemini').textContent = Math.round((article.scores?.gemini || 8) * 10) + '%';
      document.getElementById('score-grok').textContent = Math.round((article.scores?.grok || 8) * 10) + '%';
      document.getElementById('score-pplx').textContent = Math.round((article.scores?.pplx || 8) * 10) + '%';

      showScreen('detail');
    }

    function selectLength(length) {
      selectedLength = length;
      document.querySelectorAll('.length-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector(`.length-btn[data-length="${length}"]`).classList.add('selected');
    }

    // ============================================
    // PIPELINE
    // ============================================
    function startPipeline() {
      showScreen('pipeline');

      document.getElementById('pipeline-progress').style.display = 'block';
      document.getElementById('pipeline-success').classList.remove('show');

      // Reset steps
      document.querySelectorAll('.pipeline-step').forEach(s => {
        s.classList.remove('active', 'done');
      });

      runPipeline();
    }

    async function runPipeline() {
      const steps = ['analyze', 'slides', 'review', 'post'];
      let progress = 0;

      for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        const stepEl = document.getElementById('step-' + step);
        stepEl.classList.add('active');

        const messages = {
          analyze: 'Analyzing article content...',
          slides: 'Generating carousel slides...',
          review: 'AI reviewing content...',
          post: 'Posting to LinkedIn...'
        };

        document.getElementById('progress-message').textContent = messages[step];

        // Animate progress
        const startProgress = progress;
        const endProgress = (i + 1) * 25;

        for (let p = startProgress; p <= endProgress; p += 2) {
          updateProgress(p);
          await sleep(50);
        }

        progress = endProgress;
        stepEl.classList.remove('active');
        stepEl.classList.add('done');

        await sleep(500);
      }

      // Go to results screen for human review
      showResultsScreen();
    }

    function updateProgress(percent) {
      const circumference = 2 * Math.PI * 90;
      const offset = circumference - (percent / 100) * circumference;

      document.getElementById('progress-fill').style.strokeDashoffset = offset;
      document.getElementById('progress-percent').textContent = percent + '%';
    }

    function resetAndGoHome() {
      currentCardIndex++;
      selectedArticle = null;
      showScreen('swipe');
      renderCards();
    }

    // ============================================
    // SAVED ARTICLES
    // ============================================
    function renderFavorites() {
      const list = document.getElementById('favorites-list');

      if (savedForLater.length === 0) {
        list.innerHTML = `
          <div class="favorites-empty">
            <div class="icon">📌</div>
            <p>No saved articles yet.<br>Swipe down on articles to save them!</p>
          </div>
        `;
        return;
      }

      list.innerHTML = savedForLater.map(article => {
        // Extract topics
        const titleWords = (article.title + ' ' + (article.summary || '')).toUpperCase();
        const topics = topicKeywords.filter(t => titleWords.includes(t.toUpperCase())).slice(0, 3);
        if (topics.length === 0) topics.push('Tech', 'News');

        const wordCount = article.words || 0;
        const avgScore = Math.round(parseFloat(article.avgScore) * 10);
        const summary = article.summary || 'No description available.';

        return `
          <div class="favorite-item" data-id="${article.id}" onclick="toggleFavExpand(this)">
            <button class="delete-x" onclick="event.stopPropagation(); deleteSavedArticle(${article.id})">×</button>
            <div class="fav-source">${article.source}</div>
            <div class="fav-title">${article.title}</div>
            <div class="fav-topics">
              ${topics.map(t => `<span class="fav-topic">${t}</span>`).join('')}
            </div>
            <div class="fav-meta">
              <span>${article.date || 'Today'}</span>
              <span>${wordCount}w</span>
            </div>
            <div class="fav-scores">
              <span class="fav-avg">${avgScore}%</span>
              <div class="fav-logos">
                <img src="logos/chatgpt.png">
                <img src="logos/claude.png">
                <img src="logos/gemini.png">
                <img src="logos/grok.png" style="background:#333;">
                <img src="logos/perplexity.png" style="background:#fff;">
              </div>
            </div>
            <div class="fav-expanded" style="display: none;">
              <div class="fav-description">${summary}</div>
              <button class="fav-create-btn" onclick="event.stopPropagation(); postFavorite(${article.id})">Create Carousel</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleFavExpand(el) {
      const expanded = el.querySelector('.fav-expanded');
      const isVisible = expanded.style.display !== 'none';

      // Close all others first
      document.querySelectorAll('.fav-expanded').forEach(e => e.style.display = 'none');

      // Toggle this one
      expanded.style.display = isVisible ? 'none' : 'block';
    }

    function postFavorite(id) {
      const article = savedForLater.find(f => f.id === id);
      if (article) {
        selectedArticle = article;
        showLengthModal();
      }
    }

    function deleteSavedArticle(id) {
      savedForLater = savedForLater.filter(a => a.id !== id);
      localStorage.setItem('ai-radar-saved', JSON.stringify(savedForLater));
      updateSavedCount();
      renderFavorites();
      showToast('Removed');
    }

    function clearAllSaved() {
      if (savedForLater.length === 0) return;
      if (confirm('Clear all saved articles?')) {
        savedForLater = [];
        localStorage.setItem('ai-radar-saved', JSON.stringify(savedForLater));
        updateSavedCount();
        renderFavorites();
        showToast('All cleared');
      }
    }

    // ============================================
    // UTILITIES
    // ============================================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('show', show);
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ============================================
    // FLIPBOOK
    // ============================================
    let currentSlide = 0;
    let totalSlides = 5;
    let generatedSlides = [];

    function initFlipbook() {
      const flipbook = document.getElementById('flipbook');
      if (!flipbook) return;

      let startX = 0;
      let isDragging = false;

      // Touch events
      flipbook.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
      });

      flipbook.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        isDragging = false;

        const diff = e.changedTouches[0].clientX - startX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            flipPrev();
          } else {
            flipNext();
          }
        }
      });

      // Mouse events for desktop
      flipbook.addEventListener('mousedown', (e) => {
        startX = e.clientX;
        isDragging = true;
      });

      flipbook.addEventListener('mouseup', (e) => {
        if (!isDragging) return;
        isDragging = false;

        const diff = e.clientX - startX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            flipPrev();
          } else {
            flipNext();
          }
        }
      });

      // Click on slide to advance
      flipbook.addEventListener('click', () => {
        flipNext();
      });
    }

    function flipNext() {
      if (currentSlide < totalSlides - 1) {
        goToSlide(currentSlide + 1);
      }
    }

    function flipPrev() {
      if (currentSlide > 0) {
        goToSlide(currentSlide - 1);
      }
    }

    function goToSlide(index) {
      const slides = document.querySelectorAll('.flip-slide');
      const dots = document.querySelectorAll('.flip-dot');

      slides[currentSlide].classList.remove('active');
      slides[currentSlide].classList.add('prev');

      currentSlide = index;

      slides.forEach((slide, i) => {
        slide.classList.remove('active', 'prev');
        if (i === currentSlide) {
          slide.classList.add('active');
        } else if (i < currentSlide) {
          slide.classList.add('prev');
        }
      });

      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentSlide);
      });
    }

    function populateSlides(article, length, backendSlides = null) {
      // Use backend slides if available, otherwise use placeholders
      let slideData;
      if (backendSlides && backendSlides.length > 0) {
        console.log('Populating with', backendSlides.length, 'backend slides');
        slideData = backendSlides.map((s, i) => {
          // Use content from backend if available
          let body = '';
          if (s.content) {
            body = s.content;
          } else if (s.text) {
            body = s.text;
          } else if (s.status === 'complete') {
            body = '✓ Generated by Gamma AI';
          } else {
            body = 'Processing...';
          }
          return {
            title: s.name || s.title || `Slide ${i + 1}`,
            body: body
          };
        });
      } else {
        console.log('Using placeholder slides');
        // Fallback placeholders
        slideData = [
          { title: article.title, body: '' },
          { title: 'Key Insight', body: 'The main takeaway...' },
          { title: 'Why It Matters', body: 'Industry implications...' },
          { title: 'The Data', body: 'Key statistics...' },
          { title: 'What\'s Next', body: 'Future outlook...' },
          { title: 'Expert View', body: 'Analysis...' },
          { title: 'Market Impact', body: 'Industry effect...' },
          { title: 'Challenges', body: 'Obstacles...' },
          { title: 'Opportunities', body: 'Potential...' },
          { title: 'Action Items', body: 'Next steps...' },
          { title: 'Summary', body: 'Key points...' },
          { title: 'Follow for More', body: 'AI insights daily!' }
        ];
      }

      totalSlides = slideData.length;

      const flipbook = document.getElementById('flipbook');
      const dotsContainer = document.getElementById('flip-dots');

      // Generate slides HTML
      flipbook.innerHTML = slideData.map((slide, i) => `
        <div class="flip-slide ${i === 0 ? 'active' : ''}" data-slide="${i + 1}">
          <div class="slide-content">
            <div class="slide-number">${i + 1}</div>
            <div class="slide-title">${slide.title}</div>
            ${slide.body ? `<div class="slide-body">${slide.body}</div>` : ''}
          </div>
        </div>
      `).join('');

      // Generate dots
      dotsContainer.innerHTML = slideData.map((_, i) => `
        <span class="flip-dot ${i === 0 ? 'active' : ''}" data-index="${i}" onclick="goToSlide(${i})"></span>
      `).join('');

      currentSlide = 0;
    }

    // Store backend result for results screen
    let lastGenerationResult = null;
    let isPreviewMode = false;

    function showResultsScreen(status = {}, isPreview = false) {
      // Store the result and preview state
      lastGenerationResult = status;
      isPreviewMode = isPreview;

      // Extract result data (backend nests it under 'result')
      const result = status.result || status;
      const slides = status.slides || [];

      // Update Post button based on preview mode
      const postBtn = document.querySelector('.action-btn.primary');
      if (postBtn) {
        postBtn.innerHTML = isPreview
          ? '<i class="fas fa-paper-plane"></i> Post Now'
          : '<i class="fas fa-check"></i> Posted!';
      }

      // Populate slides with backend data
      populateSlides(selectedArticle, selectedLength, slides);

      // Populate source info with logo
      const sourceType = selectedArticle.sourceType || selectedArticle.source?.toLowerCase() || 'newsapi';
      const sourceLogos = {
        'newsapi': 'assets/newsapi.png',
        'newsdata': 'assets/newsdata.png',
        'perplexity': 'assets/perplexity.png',
        'grok': 'logos/grok.png',
        'feedly': 'assets/feedly.png'
      };
      const sourceNames = {
        'newsapi': 'NewsAPI',
        'newsdata': 'NewsData',
        'perplexity': 'Perplexity',
        'grok': 'Grok',
        'feedly': 'Feedly'
      };

      document.getElementById('results-source-logo').src = sourceLogos[sourceType] || sourceLogos['newsapi'];
      document.getElementById('results-source-name').textContent = sourceNames[sourceType] || selectedArticle.source || 'Unknown Source';
      document.getElementById('results-article-title').textContent = selectedArticle.title || 'Untitled Article';

      // Set link URLs from backend result
      // Gamma URL
      let gammaUrl = result.gamma_url || status.gamma_url || '';
      document.getElementById('gamma-link').href = gammaUrl || 'https://gamma.app';

      // Embed Gamma presentation if we have a URL
      const embedContainer = document.getElementById('gamma-embed-container');
      const flipbookContainer = document.getElementById('flipbook-container');
      const gammaEmbed = document.getElementById('gamma-embed');

      if (gammaUrl && gammaUrl.includes('gamma.app/docs/')) {
        // Extract doc ID and create embed URL
        const docId = gammaUrl.split('/docs/')[1]?.split('?')[0];
        if (docId) {
          const embedUrl = `https://gamma.app/embed/${docId}`;
          console.log('Embedding Gamma:', embedUrl);
          gammaEmbed.src = embedUrl;
          embedContainer.style.display = 'block';
          flipbookContainer.style.display = 'none';
        }
      } else {
        // Fallback to flipbook
        embedContainer.style.display = 'none';
        flipbookContainer.style.display = 'block';
        populateSlides(selectedArticle, selectedLength, slides);
      }

      // Download/PDF link
      let pdfUrl = result.pdf_url || selectedArticle.link || '#';
      document.getElementById('download-link').href = pdfUrl;

      // LinkedIn link - use actual posted URL
      let linkedinUrl = result.linkedin_url || status.linkedin_post_url || '';
      if (!linkedinUrl) {
        linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(selectedArticle.link || '')}`;
      }
      document.getElementById('linkedin-link').href = linkedinUrl;

      console.log('Results:', { gammaUrl, pdfUrl, linkedinUrl, slides: slides.length });

      // Update the view post button in success modal if we have a LinkedIn URL
      if (status.linkedin_post_url) {
        const viewBtn = document.querySelector('.view-post-btn');
        if (viewBtn) viewBtn.href = status.linkedin_post_url;
      }

      showScreen('results');
      if (!gammaUrl) initFlipbook();
    }

    async function finalPost() {
      showLoading(true);

      // If we have a job ID and it's in preview mode, use the /post endpoint
      if (currentJobId && isPreviewMode) {
        try {
          console.log('Posting job:', currentJobId);
          const response = await fetch(`${API_BASE}/post/${currentJobId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (response.ok) {
            // Poll for posting completion
            const pollPosting = setInterval(async () => {
              try {
                const statusRes = await fetch(`${API_BASE}/status/${currentJobId}`);
                const status = await statusRes.json();
                console.log('Posting status:', status.status, status.message);

                if (status.status === 'completed') {
                  clearInterval(pollPosting);
                  showLoading(false);
                  isPreviewMode = false;
                  const linkedinUrl = status.result?.linkedin_url || status.result?.twitter_url || 'https://linkedin.com/feed';
                  showSuccessModal(linkedinUrl);
                } else if (status.status === 'failed') {
                  clearInterval(pollPosting);
                  showLoading(false);
                  showToast('Posting failed: ' + status.message);
                }
              } catch (e) {
                console.error('Poll error:', e);
              }
            }, 1000);
            return;
          }
        } catch (err) {
          console.log('Post endpoint failed:', err);
        }
      }

      // Fallback: demo mode
      console.log('Demo mode: simulating post');
      setTimeout(() => {
        showLoading(false);
        showSuccessModal();
      }, 2000);
    }

    function showSuccessModal(linkedinUrl = 'https://linkedin.com/feed') {
      const modal = document.getElementById('success-modal');
      modal.querySelector('.view-post-btn').href = linkedinUrl;
      modal.classList.add('show');
    }

    function hideSuccessModal() {
      const modal = document.getElementById('success-modal');
      modal.classList.remove('show');
    }

    function skipAndNext() {
      currentCardIndex++;
      showScreen('swipe');
      renderCards();
    }

    function resetAndGoHome() {
      hideSuccessModal();
      currentCardIndex++;
      selectedArticle = null;
      showScreen('swipe');
      renderCards();
    }

    // ============================================
    // INIT
    // ============================================
    updateSavedCount();

    // Auto-fetch counts for default topic on load
    setTopicAndFetchCounts(selectedTopic);
  </script>
</body>
</html>
